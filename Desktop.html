<!doctype html>
<html lang="zh-Hant">
  <!-- ğŸ”’ Gatekeeper: block direct access without passcode -->
<script>
(function(){
  var KEY = 'cqe_gate_ok';
  var raw = sessionStorage.getItem(KEY) || localStorage.getItem(KEY);
  try {
    var token = raw && JSON.parse(raw);
    var ok = token && token.ok === true && (!token.exp || Date.now() < token.exp);
    if (!ok) {
      var back = location.pathname + location.search + location.hash;
      location.replace('Index.html?redir=' + encodeURIComponent(back));
    }
  } catch (e) {
    var back = location.pathname + location.search + location.hash;
    location.replace('Index.html?redir=' + encodeURIComponent(back));
  }
})();
</script>

<head>
  <script src="device-route.js"></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CQE | AI Class Check In System</title>
<script>
// 15 åˆ†é˜ (900000 æ¯«ç§’) ç„¡æ“ä½œå¾Œç™»å‡º + å°å›é¦–é 
setTimeout(async function(){
  try {
    // è‹¥ state å­˜åœ¨ï¼Œä»£è¡¨æœ‰ç™»å…¥ç‹€æ…‹ï¼Œæ¸…é™¤å®ƒ
    if (window.state && typeof signOut === 'function') {
      await signOut(); // ç™»å‡ºé‚è¼¯
    }
  } catch (e) {
    console.warn("è‡ªå‹•ç™»å‡ºéŒ¯èª¤", e);
  }
  window.location.href = "Index.html";
}, 15 * 60 * 1000);
</script>

  <meta name="description" content="CQE AI Class Check In System: REST-only, Supabase backend, file:// friendly."/>

  <style>
    :root{
      --bg:#0f1115; --card:#151922; --fg:#e7ebf2; --muted:#9aa5b1;
      --accent:#0070C0; --ok:#44c08a; --warn:#ffb020; --danger:#ff645d;
      --border:#273043; --chip:#1b2130; --radius:16px; --gap:12px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.6 system-ui,-apple-system,"Segoe UI","Microsoft JhengHei",sans-serif}
    a{color:var(--accent);text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    header{display:flex;align-items:center;gap:10px;margin:6px 0 14px}
    header .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#2a2f3a,#1b2130);display:grid;place-items:center}
    header h1{font-size:18px;margin:0}
    .tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tab-btn{background:var(--card);border:1px solid var(--border);color:var(--fg);padding:6px 12px;line-height:1.3;border-radius:12px;cursor:pointer}
    .tab-btn.active{outline:2px solid var(--accent)}
    .grid{display:grid;gap:var(--gap)}
    .g2{grid-template-columns:1fr 1fr}
    @media(max-width:900px){.g2{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:14px}
    .card h3{margin:0 0 10px;font-size:16px}
    label{display:block;font-size:13px;color:var(--muted);margin:10px 0 6px}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0e131b;color:var(--fg)}
    button{
      appearance:none;border:none;background:var(--accent);color:#fff;border-radius:12px;
      padding:6px 12px;line-height:1.3;cursor:pointer;text-shadow:0 1px 2px rgba(0,0,0,.8)
    }
    button.ghost{background:#1c2433;color:var(--fg);border:1px solid var(--border);padding:6px 12px;line-height:1.3}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:6px;background:#1b2130;border:1px solid var(--border);padding:6px 8px;border-radius:999px;font-size:12px}
    .muted{color:var(--muted)}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .danger{color:var(--danger)}
    .hide{display:none}
    .note{font-size:12px;color:var(--muted)}
/* ğŸ‘‡ æ–°å¢é€™ä¸‰æ¢ï¼Œæ”¾åœ¨ .note å¾Œé¢ï¼Œæå‡ã€ŒåŒæ™‚å¸¶ note èˆ‡ç‹€æ…‹ã€æ™‚çš„å„ªå…ˆåº¦ */
.note.warn   { color: var(--warn); }
.note.ok     { color: var(--ok); }
.note.danger { color: var(--danger); }
/* çµ±è¨ˆæ•¸å­—æ›´æ–°å‹•ç•«ï¼ˆ#todayInfoï¼‰ */
@keyframes stat-bump {
  0%   { transform: scale(1);   opacity: .85; }
  35%  { transform: scale(1.06); }
  100% { transform: scale(1);   opacity: 1; }
}
#todayInfo.bump {
  animation: stat-bump .45s ease;
}

    .list{display:grid;gap:8px}
    .list .item{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#0e131b;border:1px solid var(--border);border-radius:12px}

    /* CSV å€å¡Šæ’ç‰ˆä¿®æ­£ */
    #cardCsv input[type="file"]{display:block;width:100%;margin:8px 0 10px;padding:8px;border-radius:12px}
    #cardCsv .row{display:flex;flex-wrap:wrap;gap:8px}
    #cardCsv .row button{flex:1 1 180px;min-width:160px;margin-top:4px}
    #csvMsg{margin-top:8px;display:block}

    /* å­¸å“¡åç‰‡ */
    #studentCards { display:grid; gap:10px; grid-template-columns: 1fr; }
#studentCards .card-item{
  background:#0e131b;
  border:1px solid var(--border);
  border-radius:14px;
  padding:6px;
  display:flex;
  flex-direction:column;
  gap:6px;
  cursor:pointer;
  transition:transform .12s ease, border-color .12s ease, box-shadow .12s ease, background-color .12s ease;
}
#studentCards .card-item:hover{
  transform:translateY(-2px);
  border-color:#3a4a66;
  background:#111827;
  box-shadow:0 8px 16px rgba(0,0,0,.35);
}

    #studentCards .row-top{display:flex;align-items:center;gap:8px}
    #studentCards .avatar{
      width:28px;height:28px;border-radius:50%;
      background:#1b2130;display:grid;place-items:center;
      font-size:12px;font-weight:700;color:#e7ebf2;
    }
    #studentCards .meta{font-size:12px;color:#9aa5b1}
    #studentCards .checked{border-color:#44c08a!important}
    #studentCards .chip-ok{font-size:11px;background:#12392c;color:#9af0c7;border:1px solid #1f6b51;border-radius:999px;padding:2px 6px}
    /* åƒ…éš±è— ID(å·¥è™Ÿ) èˆ‡ Teamï¼Œä¸éš±è—é ­åƒ */
    #studentCards .row-top .meta { display: none !important; }
    #studentCards .avatar { display: grid !important; }
    #studentCards .row-top > div:not(.avatar) { margin-left: 0; }

    /* æ·±è‰²åŸç”Ÿæ§ä»¶ï¼ˆå«è‡ªè¨‚ç™½è‰²æ—¥æ›†/æ™‚é˜åœ–ç¤ºè¦†è“‹ï¼‰ */
    :root{color-scheme:dark}
    input[type="date"],input[type="time"],select{background:#0e131b;color:#e7ebf2;border:1px solid #273043}
    input[type="date"]::-webkit-calendar-picker-indicator,
    input[type="time"]::-webkit-calendar-picker-indicator{opacity:0}
    input[type="time"]::-webkit-clear-button,
    input[type="time"]::-webkit-inner-spin-button{opacity:0}
    .picker-wrap{position:relative}
    .picker-wrap>input[type="date"],.picker-wrap>input[type="time"]{padding-right:42px}
    .picker-btn{position:absolute;right:10px;top:50%;transform:translateY(-50%);width:24px;height:24px;border:none;background:transparent;cursor:pointer;padding:0;opacity:.95}
    .picker-btn:focus{outline:2px solid #4aa3ff;outline-offset:2px;border-radius:8px}
    .picker-btn.calendar{
      background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><rect x='3' y='4' width='18' height='18' rx='2' ry='2'/><line x1='16' y1='2' x2='16' y2='6'/><line x1='8' y1='2' x2='8' y2='6'/><line x1='3' y1='10' x2='21' y2='10'/></svg>");
      background-repeat:no-repeat;background-size:22px 22px;background-position:center;filter:drop-shadow(0 1px 2px rgba(0,0,0,.6))
    }
    .picker-btn.clock{
      background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><circle cx='12' cy='12' r='10'/><polyline points='12 6 12 12 16 14'/></svg>");
      background-repeat:no-repeat;background-size:22px 22px;background-position:center;filter:drop-shadow(0 1px 2px rgba(0,0,0,.6))
    }

    /* Backfill table */
    #backfillTable{width:100%;border-collapse:separate;border-spacing:0 6px}
    #backfillTable th,#backfillTable td{padding:8px 10px}
    #backfillTable thead th{font-size:12px;color:#9aa5b1;text-align:left}
    #backfillTable tbody tr{background:#0e131b;border:1px solid var(--border)}
    #backfillTable tbody tr td{border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
    #backfillTable tbody tr td:first-child{border-left:1px solid var(--border);border-top-left-radius:10px;border-bottom-left-radius:10px}
    #backfillTable tbody tr td:last-child{border-right:1px solid var(--border);border-top-right-radius:10px;border-bottom-right-radius:10px}
    #backfillTable td:last-child, #backfillTable th:last-child { text-align: center; }

    /* Admin å…§å±¤åˆ†é  */
    .subtabs{display:flex;gap:8px;margin:4px 0 10px;flex-wrap:wrap}
    .subtab-btn{background:#0e131b;border:1px solid var(--border);color:#e7ebf2;padding:6px 12px;border-radius:10px;cursor:pointer}
    .subtab-btn.active{outline:2px solid var(--accent)}
/* åœ“å½¢ icon æŒ‰éˆ•æ¨£å¼ */
.icon-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 34px;
  height: 34px;
  border-radius: 50%;
  background: #1c2433;
  border: 1px solid var(--border);
  cursor: pointer;
  color: var(--fg);
  transition: all 0.15s ease;
}

.icon-btn:hover {
  border-color: var(--accent);
  color: var(--accent);
  background: #0e131b;
}

.icon-btn svg {
  width: 10px;       /* èª¿æ•´ç®­é ­å¤§å° */
  height: 10px;
  stroke-width: 3; /* èª¿æ•´ç·šæ¢ç²—ç´° */
  flex-shrink: 0;    /* é¿å…è¢«å£“ç¸® */
  pointer-events: none;
}
/* é»æ“Šæ—‹è½‰å‹•ç•« */
@keyframes spin-once {
  from { transform: rotate(0deg); }
  to   { transform: rotate(360deg); }
}

.icon-btn.spin svg {
  animation: spin-once 0.6s ease;
}
/* å ±åˆ°å€å¡Šè£¡ï¼Œå…©å€‹ row å…ƒç´ é€£åœ¨ä¸€èµ·æ™‚ï¼Œè‡ªå‹•åœ¨ä¸Šæ–¹ç•™ç™½ */
#tab-checkin .row + .row {
  margin-top: 8px;
}
/* è‡ªåŠ©å ±åˆ° Add/æ¸…é™¤ æŒ‰éˆ•åˆ— */
#btnCheckin, 
#btnClearEmp {
  margin-top: 8px;
}

/* è‡ªåŠ©å»ºç«‹å­¸å“¡ å»ºç«‹ä¸¦å ±åˆ°/å–æ¶ˆ æŒ‰éˆ•åˆ— */
#btnCreateStudent, 
#btnCancelCreate {
  margin-top: 8px;
}
/* å­¸å“¡åå–®ï¼ˆå¾Œå°è¡¨æ ¼ï¼‰æ‡¸åœæ•ˆæœ */
#stuTable tbody tr{
  transition: background-color .12s ease, box-shadow .12s ease, transform .08s ease, border-color .12s ease;
}
#stuTable tbody tr:hover{
  background:#121826 !important;
  /* ä¸Šä¸‹å·¦å³çš„é‚Šç·šåœ¨ä½ çš„ç¨‹å¼è£¡æ˜¯å„å€‹ td å„è‡ªç•«çš„ï¼Œé€™è£¡ä¸€èµ·æäº® */
  border-color:#3a4a66;
  transform:translateY(-1px);
  box-shadow:0 6px 12px rgba(0,0,0,.28);
}
#stuTable tbody tr:hover td{
  border-top-color:#3a4a66 !important;
  border-bottom-color:#3a4a66 !important;
}
#stuTable tbody tr:hover td:first-child{
  border-left-color:#3a4a66 !important;
}
#stuTable tbody tr:hover td:last-child{
  border-right-color:#3a4a66 !important;
}

/* å¯æ’åºè¡¨é ­çš„æ‡¸åœæç¤ºï¼ˆä½ å·²æŠŠ cursor è¨­ pointerï¼Œé€™è£¡å†åŠ é¡è‰²è®ŠåŒ–ï¼‰ */
#stuTable thead th[data-sort]{
  transition: color .12s ease, text-shadow .12s ease;
}
#stuTable thead th[data-sort]:hover{
  color:#e7ebf2;
  text-shadow:0 0 6px rgba(74,163,255,.6);
}
.error  { color: var(--danger); }
.success{ color: var(--ok); }

</style>
</head>
<body>
<div class="wrap">
<header>
  <div class="logo">
    <img src="bear-logo.png" alt="CQE Logo" style="width:100%;height:100%;object-fit:contain;border-radius:10px">
  </div>
  <div>
    <h1>CQE | AI Class Check In System</h1>
    <div class="muted" id="deviceText">è£ç½®æª¢æ¸¬ä¸­â€¦</div>
  </div>
</header>

  <div class="tabs" role="tablist" style="display:flex;align-items:center;justify-content:space-between">
    <div style="display:flex;gap:6px">
      <button class="tab-btn active" data-tab="checkin">å­¸å“¡å ±åˆ°</button>
      <button class="tab-btn" data-tab="admin">ç®¡ç†å¾Œå°</button>
    </div>
    <div id="authArea"></div>
  </div>

  <!-- å­¸å“¡å ±åˆ° -->
  <section id="tab-checkin" class="grid g2" style="margin-top:12px">
    <div class="card">
  <h3 style="margin:0; display:flex; justify-content:space-between; align-items:center;">
  <span>Next Class</span>
  <span id="todayInfo" class="note warn" style="font-weight:normal; text-align:right;"></span>
</h3>


  <div class="toolbar row" id="todayToolbar" style="align-items:center">
    <select id="selCourseToday" style="flex:1; min-width:260px"></select>
    <!-- Import æ›æˆåœ“å½¢ icon -->
    <button id="btnReloadToday" class="icon-btn" title="é‡æ–°è¼‰å…¥">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
        <polyline points="23 4 23 10 17 10"></polyline>
        <polyline points="1 20 1 14 7 14"></polyline>
        <path d="M3.51 9a9 9 0 0 1 14.13-3.36L23 10"></path>
        <path d="M20.49 15a9 9 0 0 1-14.13 3.36L1 14"></path>
      </svg>
    </button>
  </div>

<div class="toolbar row" style="margin-top:8px; align-items:center">
  <input id="studentSearch" placeholder="æœå°‹å­¸å“¡ï¼ˆTeam / Name / IDï¼‰"
         style="flex:1; min-width:260px"/>
  <button id="btnReloadStudents" class="icon-btn" title="é‡æ–°æ•´ç†">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
        <polyline points="23 4 23 10 17 10"></polyline>
        <polyline points="1 20 1 14 7 14"></polyline>
        <path d="M3.51 9a9 9 0 0 1 14.13-3.36L23 10"></path>
        <path d="M20.49 15a9 9 0 0 1-14.13 3.36L1 14"></path>
      </svg>
    </button>
  </div>
  <div id="studentCards" style="margin-top:8px"></div>

<!-- æ–°å¢ï¼šå­¸å“¡åç‰‡åˆ†é  -->
<div id="studentPager" class="row" style="margin-top:8px; align-items:center; justify-content:flex-end; gap:6px">
  <!-- é€™è£¡ç”± JS å‹•æ…‹å¡«å…¥åˆ†é æŒ‰éˆ•èˆ‡è³‡è¨Š -->
</div>

</div>


    <div class="card">
  <h3>è‡ªåŠ©å ±åˆ°</h3>
  <input id="inpEmp" placeholder="Team / Name / ID" autocomplete="off"/>
  <div class="row">
    <button id="btnCheckin">Add</button>
    <button id="btnClearEmp" class="ghost">æ¸…é™¤</button>
  </div>
  <div id="checkinMsg" class="note" style="margin-top:8px"></div>

  <hr style="border:none;border-top:1px dashed var(--border);margin:12px 0">
  <div id="selfCreateBox" class="hide">
    <h3>ä¸åœ¨åå–®ï¼Ÿè‡ªåŠ©å»ºç«‹å­¸å“¡</h3>
    <div class="row">
      <div style="flex:1">
        <label>Team</label>
        <input id="inpTeam" placeholder="Team (çµ„ç«™)"/>
      </div>
      <div style="flex:1">
        <label>å§“å</label>
        <input id="inpName" placeholder="è‹±æ–‡"/>
      </div>
    </div>
    <label>IDï¼ˆå·¥è™Ÿï¼‰</label>
    <input id="inpEmp2" placeholder="ID / å·¥è™Ÿ"/>
    <div class="row" style="margin-top:8px">
      <button id="btnCreateStudent">å»ºç«‹ä¸¦å ±åˆ°</button>
      <button id="btnCancelCreate" class="ghost">å–æ¶ˆ</button>
    </div>

    <div class="note">ï¼ŠæŒ‰ã€Œå»ºç«‹ä¸¦å ±åˆ°ã€å¾Œï¼Œç³»çµ±æœƒç”¨é€™ç­†è³‡æ–™å®Œæˆæœ¬æ¬¡å ±åˆ°ã€‚</div>
  </div>
</div>

  </section>

  <!-- ç®¡ç†å¾Œå°ï¼ˆå…§å±¤åˆ†é ï¼‰ -->
  <section id="tab-admin" class="hide" style="margin-top:12px">
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center"></div>

      <div class="subtabs" role="tablist" id="adminTabs">
        <button class="subtab-btn active" data-admin="login">ç™»å…¥</button>
        <button class="subtab-btn" data-admin="courses">èª²ç¨‹</button>
        <button class="subtab-btn" data-admin="csv">åå–®åŒ¯å…¥</button>
<button class="subtab-btn" data-admin="students">å­¸å“¡åå–®</button>
        <button class="subtab-btn" data-admin="chart">åœ–è¡¨</button>
        <button class="subtab-btn" data-admin="backfill">éå»è£œç™»</button>
      </div>

      <!-- å…§å±¤ï¼šç™»å…¥ -->
      <div id="admin-login" class="admin-pane">
        <div id="boxSignIn">
          <label>Email</label>
          <input id="inpEmail" type="email" placeholder="admin@example.com"/>
          <label>Password</label>
          <div class="row" style="flex-wrap:nowrap">
            <input id="inpPwd" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" style="flex:1"/>
            <button id="btnTogglePwd" class="ghost">é¡¯ç¤ºå¯†ç¢¼</button>
          </div>
          <div class="row" style="margin-top:8px">
            <button id="btnDoSignIn">ç™»å…¥</button>
            <button id="btnSignOut" class="ghost hide">ç™»å‡º</button>
          </div>
          <div id="loginError" class="error hide" style="margin-top:8px"></div>
          <div id="boxSigned" class="hide success" style="margin-top:8px">å·²ç™»å…¥ï¼Œå¯é€²è¡Œèª²ç¨‹èˆ‡çµ±è¨ˆç®¡ç†ã€‚</div>
        </div>
      </div>

      <!-- å…§å±¤ï¼šèª²ç¨‹ -->
      <div id="admin-courses" class="admin-pane hide">
        <div class="card" style="margin-top:10px">
          <h3>å»ºç«‹èª²ç¨‹</h3>
          <label>èª²ç¨‹åç¨±</label>
          <input id="inpTitle" placeholder="ä¾‹å¦‚ï¼šUI/UX å…¥é–€"/>
          <div class="row">
            <div style="flex:1">
              <label>æ—¥æœŸ</label>
              <input id="inpDate" type="date"/>
            </div>
            <div style="flex:1">
              <label>é–‹å§‹æ™‚é–“</label>
              <input id="inpStart" type="time"/>
            </div>
            <div style="flex:1">
              <label>çµæŸæ™‚é–“</label>
              <input id="inpEnd" type="time"/>
            </div>
          </div>
          <label>èªªæ˜ï¼ˆé¸å¡«ï¼‰</label>
          <textarea id="inpDesc" rows="2" placeholder="èª²ç¨‹ç°¡ä»‹â€¦"></textarea>
          <div class="row">
            <button id="btnCreateCourse">å»ºç«‹èª²ç¨‹</button>
            <button id="btnLoadCourses" class="ghost">è¼‰å…¥èª²ç¨‹æ¸…å–®</button>
          </div>
          <div id="courseMsg" class="note"></div>
          <div class="list" id="listCourses" style="margin-top:8px"></div>
        </div>
      </div>

      <!-- å…§å±¤ï¼šåå–®åŒ¯å…¥ -->
      <div id="admin-csv" class="admin-pane hide">
        <div class="card" id="cardCsv" style="margin-top:10px">
          <h3>æ‰¹æ¬¡å»ºç«‹å­¸å“¡åå–®ï¼ˆCSVï¼šTeam,Name(EN),IDï¼‰</h3>
          <input id="fileCsv" type="file" accept=".csv"/>
          <div class="row">
            <button id="btnImportCsv">åŒ¯å…¥åå–®</button>
            <button id="btnExportSample" class="ghost">ä¸‹è¼‰ç¯„ä¾‹ CSV</button>
          </div>
          <div id="csvMsg" class="note"></div>
        </div>
      </div>

<!-- å…§å±¤ï¼šå­¸å“¡åå–® -->
<div id="admin-students" class="admin-pane hide">
  <div class="card" style="margin-top:10px">
    <!-- âœ… æ”¹æˆï¼šæ¨™é¡Œ + æœå°‹ + å…©é¡†æŒ‰éˆ•éƒ½åœ¨åŒä¸€åˆ— -->
    <div class="row" id="stuToolbar" style="align-items:center; gap:8px; flex-wrap:wrap">
      <h3 style="margin:0">å­¸å“¡åå–®</h3>
      <input id="stuQuery" placeholder="æœå°‹ Team / Name / ID" style="flex:1; min-width:260px">
      <button id="btnStuReload" class="ghost">é‡æ–°æ•´ç†</button>
      <button id="btnStuCreate">Add</button>
    </div>


    <div id="stuMsg" class="note" style="margin-top:8px"></div>

    <div style="margin-top:8px;max-height:420px;overflow:auto">
      <table id="stuTable" style="width:100%;border-collapse:separate;border-spacing:0 6px">
 <thead>
  <tr>
    <th data-sort="team"         style="cursor:pointer;text-align:left;padding:8px 10px;color:#9aa5b1;font-size:12px">Team<span class="sort-icon" style="margin-left:6px;opacity:.7"></span></th>
    <th data-sort="name"         style="cursor:pointer;text-align:left;padding:8px 10px;color:#9aa5b1;font-size:12px">Name (EN)<span class="sort-icon" style="margin-left:6px;opacity:.7"></span></th>
    <th data-sort="employee_no"  style="cursor:pointer;text-align:left;padding:8px 10px;color:#9aa5b1;font-size:12px">ID<span class="sort-icon" style="margin-left:6px;opacity:.7"></span></th>
    <th                          style="text-align:center;padding:8px 10px;color:#9aa5b1;font-size:12px">æ“ä½œ</th>
  </tr>
</thead>

        <tbody id="stuTbody"></tbody>
      </table>
    </div>

    <!-- åˆ†é åˆ— -->
    <div class="row" id="stuPager" style="margin-top:8px;justify-content:flex-end;align-items:center;gap:8px"></div>
  </div>
</div>

      <!-- å…§å±¤ï¼šåœ–è¡¨ -->
      <div id="admin-chart" class="admin-pane hide">
        <div class="card" id="cardChart" style="margin-top:10px">
          <div class="row" style="position:relative;justify-content:flex-end;align-items:center;margin-bottom:6px">
            <h3 style="margin:0;position:absolute;left:50%;transform:translateX(-50%);">èª²ç¨‹äººæ¬¡ | åœ–è¡¨</h3>
            <button id="btnExportAttend" class="ghost">åŒ¯å‡ºä¸Šèª²äººå“¡</button>
          </div>
          <canvas id="chart" height="80"></canvas>
          <div class="note">ï¼Šé¡¯ç¤ºæ¯é–€èª²çš„å‡ºå¸­äººæ•¸ã€‚</div>
        </div>
      </div>

      <!-- å…§å±¤ï¼šéå»è£œç™» -->
      <div id="admin-backfill" class="admin-pane hide">
        <div class="card" id="cardBackfill" style="margin-top:10px">
          <h3>éå»èª²ç¨‹è£œç™»</h3>
          <div class="row">
            <select id="selBackfillCourse" style="min-width:260px"></select>
            <button id="btnLoadBackfill" class="ghost">è¼‰å…¥å­¸å“¡</button>
          </div>
          <div class="row" style="margin-top:8px">
            <input id="inpBulkIDs" placeholder="æœå°‹ Team / Name / ID" style="flex:1;min-width:300px">
            <button id="btnBulkAdd" class="ghost">æŸ¥è©¢</button>
          </div>
          <div id="backfillMsg" class="note" style="margin-top:8px"></div>
          <div style="margin-top:8px;max-height:360px;overflow:auto">
            <table id="backfillTable">
              <thead><tr><th>Team</th><th>Name (EN)</th><th>ID</th><th>ç‹€æ…‹/é¸å–</th></tr></thead>
              <tbody id="backfillTbody"></tbody>
            </table>
          </div>
          <div class="row" style="margin-top:8px">
            <button id="btnSaveChecked">å°‡å‹¾é¸è€…è£œç™»ç‚ºå·²å ±åˆ°</button>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- ç¬¬ä¸‰æ–¹å¥—ä»¶ï¼ˆå…ˆè¼‰ï¼Œä½†ä¸»ç¨‹å¼ä»æœ‰ä¿éšª ensureChartJs()ï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<!-- ğŸ‘‡ æ–°å¢ï¼šSupabase JSï¼ˆRealtime éœ€è¦å®ƒï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  // ===== Supabase è¨­å®š =====
  const SUPABASE_URL = 'https://kxyguqnoudtnxkexbsnc.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4eWd1cW5vdWR0bnhrZXhic25jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5MzQxODUsImV4cCI6MjA3MTUxMDE4NX0.Tpv6J1KM10lyrLORWdXjN45YGedcCrjdjjdYV61qp38';

  // ğŸ‘‡ æ–°å¢ï¼šçµ¦ Realtime ç”¨çš„ supabase-js client
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// === Broadcastï¼šæ¥æ”¶ä»–è£ç½®çš„å³æ™‚å ±åˆ° ===
let __bc = null;
function setupBroadcastReceiver(){
  try{
    if (__bc){ sb.removeChannel(__bc); __bc = null; }
    __bc = sb.channel('checkin-bc', { config:{ broadcast:{ self:false } } })
      .on('broadcast', { event:'checkin' }, (msg)=>{
        const p = msg?.payload || {};
        // åƒ…ç•¶å‰èª²ç¨‹æ‰è™•ç†
        const cur = selCourseToday?.value;
        if (!cur || p.course_id != cur) return;

        const sid = p.student_id;
        if (!sid) return;

        // æœ¬åœ°é›†åˆ + ç•«é¢ç«‹å³æ›´æ–°ï¼ˆä¸å¿…é‡æ’ˆï¼‰
        __checkedSet.add(sid);
        const card = studentCards?.querySelector(`[data-sid="${sid}"]`);
        if (card){
          card.classList.add('checked');
          if (!card.querySelector('.chip-ok')){
            const ok = document.createElement('span');
            ok.className = 'chip-ok'; ok.textContent = 'å·²å ±åˆ°'; ok.style.marginLeft='auto';
            card.querySelector('.row-top')?.appendChild(ok);
          }
        }
        updateTodayStats(); // å³ä¸Šçµ±è¨ˆä¸€èµ·æ›´æ–°
      })
      .subscribe();
  }catch(e){ console.warn('Broadcast receiver å•Ÿå‹•å¤±æ•—ï¼š', e); }
}
// === å»£æ’­é€å‡ºï¼šå ±åˆ°æˆåŠŸæ™‚å‘¼å« ===
let __bcReady = null;
function ensureBroadcast(){
  if (!__bc){
    __bc = sb.channel('checkin-bc', { config:{ broadcast:{ self:false } } });
    __bcReady = new Promise((resolve)=>{
      __bc.subscribe((status)=>{
        if (status === 'SUBSCRIBED') resolve();
      });
    });
  }
  return __bc;
}
async function emitCheckin(course_id, student_id){
  try{
    ensureBroadcast();
    await __bcReady;
    await __bc.send({
      type:'broadcast',
      event:'checkin',
      payload:{ course_id:String(course_id), student_id:String(student_id), ts:Date.now() }
    });
  }catch(e){ console.warn('broadcast é€å‡ºå¤±æ•—ï¼š', e); }
}

  const $=(q)=>document.querySelector(q);
// === Utils: æ–‡å­—è½‰ç¾© & ç”¢ç”Ÿé ­åƒç¸®å¯« ===
function escapeHtml(str){
  return String(str || '').replace(/[&<>"']/g, s => ({
    '&':'&amp;',
    '<':'&lt;',
    '>':'&gt;',
    '"':'&quot;',
    "'":'&#39;'
  }[s]));
}

function getInitials(name, alt){
  const base = String(name || '').trim();
  const words = (base.match(/[A-Za-z]+/g) || []);
  if (words.length >= 2) return (words[0][0] + words[1][0]).toUpperCase();
  if (words.length === 1) return words[0].slice(0,2).toUpperCase();
  const altLetters = String(alt || '').replace(/[^A-Za-z]/g, '');
  if (altLetters) return altLetters.slice(0,2).toUpperCase();
  const noSpace = base.replace(/\s+/g,'').slice(0,2);
  return (noSpace || '??').toUpperCase();
}


  // ===== é€šç”¨ REST å‘¼å« / ç‹€æ…‹ =====
  const state = {
    access_token: localStorage.getItem('sb_access_token') || null,
    user_email: localStorage.getItem('sb_user_email') || null,
  };
  function saveState(){
    if (state.access_token) localStorage.setItem('sb_access_token', state.access_token); else localStorage.removeItem('sb_access_token');
    if (state.user_email) localStorage.setItem('sb_user_email', state.user_email); else localStorage.removeItem('sb_user_email');
  }
  async function rest(path, { method='GET', body=null, auth=false, headers={} }={}){
  const h = { 'apikey': SUPABASE_ANON_KEY, 'Accept':'application/json', ...headers };
  if (auth && state.access_token) h['Authorization'] = 'Bearer '+state.access_token;
  if (body && !h['Content-Type']) h['Content-Type'] = 'application/json';
  const res = await fetch(SUPABASE_URL + path, { method, headers:h, body });
  const txt = await res.text();
  let data=null; try{ data = txt? JSON.parse(txt): null }catch{ data = txt }
  if (!res.ok){
    const msg = data?.error_description || data?.message || data?.msg || (res.status+' '+res.statusText);
    const err = new Error(msg);
    err.status  = res.status;
    err.code    = data?.code;
    err.details = data?.details;
    throw err;
  }
  return data;
}

/* === æ–°å¢é–‹å§‹ï¼šå°ˆé–€ç”¨ä¾†åšã€Œåˆ—è¡¨ + ç¸½ç­†æ•¸ã€çš„æŸ¥è©¢ === */
async function restWithCount(path, { method='GET', body=null, auth=false, headers={}, limit=null, offset=null }={}){
  const h = {
    'apikey': SUPABASE_ANON_KEY,
    'Accept': 'application/json',
    // ç”¨ header å–ç¸½ç­†æ•¸
    'Prefer': 'count=exact',
    ...headers
  };
  if (auth && state.access_token) h['Authorization'] = 'Bearer ' + state.access_token;
  if (body && !h['Content-Type']) h['Content-Type'] = 'application/json';

  // è£œä¸Š limit/offsetï¼ˆæœ‰éœ€è¦æ‰åŠ åœ¨ URLï¼‰
  const url = new URL(SUPABASE_URL + path);
  if (typeof limit === 'number')  url.searchParams.set('limit',  String(limit));
  if (typeof offset === 'number') url.searchParams.set('offset', String(offset));

  const res = await fetch(url.toString(), { method, headers: h, body });
  const txt = await res.text();
  let data=null; try{ data = txt? JSON.parse(txt): null }catch{ data = txt }

  if (!res.ok){
    const msg = data?.error_description || data?.message || data?.msg || (res.status+' '+res.statusText);
    const err = new Error(msg); err.status=res.status; err.code=data?.code; err.details=data?.details;
    throw err;
  }

  // å¾ Content-Range è®€ totalï¼šå½¢å¦‚ "0-9/123"
  const range = res.headers.get('Content-Range') || '';
  const m = range.match(/\/(\d+)$/);
  const total = m ? Number(m[1]) : (Array.isArray(data) ? data.length : 0);

  return { rows: Array.isArray(data) ? data : [], total };
}
/* === æ–°å¢çµæŸ === */
  // ===== Chart.js è¼‰å…¥ä¿éšªï¼ˆæ”¯æ´ window.Chart èˆ‡ window.Chart.Chartï¼‰=====
  async function ensureChartJs(){
    const ok = !!(window.Chart && (typeof window.Chart === 'function' || typeof window.Chart?.Chart === 'function'));
    if (ok) return;
    const urls = [
      'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js',
      'https://unpkg.com/chart.js@4.4.1/dist/chart.umd.min.js'
    ];
    for (const url of urls){
      try{
        await new Promise((resolve, reject)=>{
          const s=document.createElement('script');
          s.src=url; s.async=true; s.onload=resolve; s.onerror=reject;
          document.head.appendChild(s);
        });
        if (window.Chart && (typeof window.Chart === 'function' || typeof window.Chart?.Chart === 'function')) return;
      }catch(e){ /* try next */ }
    }
    throw new Error('Chart.js è¼‰å…¥å¤±æ•—');
  }

  // ===== é ç±¤åˆ‡æ›ï¼ˆå¤–å±¤ï¼‰ =====
  document.querySelectorAll('.tab-btn')?.forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.dataset.tab;
    $('#tab-checkin').classList.toggle('hide', tab!=='checkin');
    $('#tab-admin').classList.toggle('hide', tab!=='admin');
    if (tab==='admin') {
      ensureAdminDefaultTab();
    } else if (tab==='checkin') {
      // ğŸ”„ æ¯æ¬¡åˆ‡å›å­¸å“¡å ±åˆ°å°±åˆ·æ–°ä»Šæ—¥èª²/ä¸‹ä¸€èª² + åå–®/çµ±è¨ˆ
      try{ await loadToday(); }catch{}
    }
  });
});


  // ===== ç®¡ç†å¾Œå° å…§å±¤åˆ†é æ§åˆ¶ =====
  const authArea = $('#authArea');
  const adminTabs = $('#adminTabs');
  function setSubtabsVisibility(loggedIn){
    document.querySelectorAll('.subtab-btn').forEach(btn=>{
      const isLogin = btn.dataset.admin === 'login';
      btn.classList.toggle('hide', loggedIn ? isLogin : !isLogin);
    });
  }
  const adminPanes = {
    login: $('#admin-login'),
    courses: $('#admin-courses'),
    csv: $('#admin-csv'),
students: $('#admin-students'), // ğŸ‘ˆ æ–°å¢
    chart: $('#admin-chart'),
    backfill: $('#admin-backfill'),
  };
function showAdminTab(name){
  const mustLogin = (name!=='login');
  if (mustLogin && !state.access_token) name = 'login';

  document.querySelectorAll('.subtab-btn').forEach(b=>{
    b.classList.toggle('active', b.dataset.admin===name);
  });
  Object.entries(adminPanes).forEach(([k,el])=>{
    el.classList.toggle('hide', k!==name);
  });

  if (name==='courses' && state.access_token){ try{ loadCourses(); }catch{} }
  if (name==='csv' && state.access_token){ /* noop */ }

  // åˆ‡åˆ°å­¸å“¡åå–®ï¼šå…ˆåˆå§‹åŒ–è¡¨é ­æ’åºï¼Œå†è¼‰å…¥ç¬¬ä¸€é 
  if (name==='students' && state.access_token){
    try { initStuSortHeaders(); } catch {}
    try { loadStudentsAdmin(true); } catch {}
  }


  if (name==='chart' && state.access_token){ try{ setTimeout(()=>requestAnimationFrame(loadStackedChart), 0); }catch{} }
  if (name==='backfill' && state.access_token){ try{ loadAllCoursesForBackfill(); }catch{} }
}
  function ensureAdminDefaultTab(){ showAdminTab(state.access_token ? 'courses' : 'login'); }
  adminTabs?.addEventListener('click',(e)=>{
    const btn = e.target.closest('.subtab-btn'); if(!btn) return;
    showAdminTab(btn.dataset.admin);
  });

  // ===== Authï¼ˆåƒ…åœ¨ç®¡ç†å¾Œå°å…§æ“ä½œï¼‰=====
  const inpEmail=$('#inpEmail'), inpPwd=$('#inpPwd'), btnDoSignIn=$('#btnDoSignIn'), btnTogglePwd=$('#btnTogglePwd'), btnSignOut=$('#btnSignOut');
  const loginError=$('#loginError'), boxSigned=$('#boxSigned');

  async function signIn(email, password){
    const data = await rest('/auth/v1/token?grant_type=password', {
      method:'POST',
      body: JSON.stringify({ email, password }),
      headers:{ 'Content-Type':'application/json' }
    });
    state.access_token = data?.access_token || null;
    state.user_email = email;
    saveState();
    return data;
  }
  async function signOut(){ state.access_token=null; state.user_email=null; saveState(); }

  function setLoginError(msg){
    if (!loginError) return;
    if (!msg){ loginError.classList.add('hide'); loginError.textContent=''; }
    else { loginError.textContent=msg; loginError.classList.remove('hide'); }
  }
function refreshAuthUI(){
  const loggedIn = !!state.access_token;
  const authArea = document.querySelector('#authArea');

  if (authArea){
    if (loggedIn){
      authArea.innerHTML = '';

      const logoutBtn = document.createElement('button');
      logoutBtn.id = 'btnLogoutHeader';
      logoutBtn.textContent = 'Log Out';
      logoutBtn.className = 'ghost';
      logoutBtn.addEventListener('click', async ()=>{
        await signOut();
        refreshAuthUI();
        showAdminTab('login');
      });
      authArea.appendChild(logoutBtn);

      // === ç™»å…¥å¾Œå…¨ç«™ç›£æ§ï¼š15 åˆ†é˜æœªæ“ä½œè‡ªå‹•ç™»å‡º ===
      (function(){
        let logoutTimer = null;
        const AUTO_LOGOUT_MS = 15 * 60 * 1000; // 15 åˆ†é˜

        function resetLogoutTimer(){
          if (logoutTimer) clearTimeout(logoutTimer);
          if (!state.access_token) return;
          logoutTimer = setTimeout(async () => {
            alert('ç³»çµ±åµæ¸¬åˆ°æ‚¨ 15 åˆ†é˜å…§ç„¡æ“ä½œï¼Œå·²è‡ªå‹•ç™»å‡ºã€‚');
            await signOut();
            refreshAuthUI();
            showAdminTab('login');
          }, AUTO_LOGOUT_MS);
        }

        ['click', 'keydown', 'mousemove', 'scroll', 'touchstart'].forEach(ev => {
          document.addEventListener(ev, resetLogoutTimer, { passive: true });
        });

        resetLogoutTimer(); // åˆæ¬¡ç™»å…¥ä¹Ÿå•Ÿå‹•å€’æ•¸
      })();

    } else {
      authArea.innerHTML = '<span class="chip">æœªç™»å…¥</span>';
    }
  }

    setSubtabsVisibility(loggedIn);
    ensureAdminDefaultTab();
    if (!loggedIn){ try{ clearChart(); }catch{} }
  }

  btnDoSignIn?.addEventListener('click', async()=>{
    setLoginError('');
    if (!inpEmail?.value || !inpPwd?.value) { setLoginError('è«‹è¼¸å…¥ Email èˆ‡ Password'); return; }
    btnDoSignIn.disabled=true; const prev=btnDoSignIn.textContent; btnDoSignIn.textContent='ç™»å…¥ä¸­â€¦';
    try{
      await signIn(inpEmail.value.trim(), inpPwd.value);
      refreshAuthUI();
      showAdminTab('courses');
    }catch(e){
      setLoginError('ç™»å…¥å¤±æ•—ï¼š' + (e?.message || e));
    }finally{
      btnDoSignIn.disabled=false; btnDoSignIn.textContent=prev;
    }
  });
  btnTogglePwd?.addEventListener('click',()=>{ if (inpPwd) inpPwd.type = (inpPwd.type==='password' ? 'text':'password'); });
  btnSignOut?.addEventListener('click', async()=>{ await signOut(); refreshAuthUI(); showAdminTab('login'); });

  // ===== ä»Šæ—¥èª²ç¨‹ï¼ˆå­¸å“¡ç«¯ï¼‰=====
const selCourseToday=$('#selCourseToday'), todayInfo=$('#todayInfo'), btnReloadToday=$('#btnReloadToday');
let __allowCheckin = false;
const fmt=(d)=> d<10? ('0'+d): (''+d);
const todayStr=()=>{ const d=new Date(); return `${d.getFullYear()}-${fmt(d.getMonth()+1)}-${fmt(d.getDate())}`; };

async function loadToday(){
  selCourseToday.innerHTML='';
  __allowCheckin = false;
  setCheckinEnabled(false);

  const today = todayStr();
  try{
    let data = await rest(`/rest/v1/courses?select=*&date=eq.${today}&order=start_time.asc`);
    if (Array.isArray(data) && data.length){
      const addOpt = (c) => {
        const t = c.start_time? `ï¼ˆ${c.start_time.slice(0,5)}~${(c.end_time||'').slice(0,5)}ï¼‰` : '';
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = `${c.title} ${t}`;
        opt.dataset.date = c.date;
        selCourseToday.appendChild(opt);
      };

      if (data.length === 1){
        addOpt(data[0]);
        selCourseToday.value = data[0].id;

        if (data[0].date === today){
          // âœ… ä»Šå¤©çš„èª² â†’ é–‹æ”¾å ±åˆ° + é¡¯ç¤ºçµ±è¨ˆ
          __allowCheckin = true;
          setCheckinEnabled(true);

          await loadStudentsAndAttendance();
// ğŸ‘‡ æ–°å¢ï¼šé€²å…¥ä»Šå¤©çš„èª² â†’ é–‹å•Ÿ Realtime è¨‚é–±
setupRealtimeAttendance(selCourseToday?.value || null);
          const total = __studentsCache.length;
          const checked = __checkedSet.size;
          const unchecked = Math.max(0, total - checked);
          const rate = total > 0 ? Math.round((checked/total)*100) : 0;

          todayInfo.textContent = `å·²å ±åˆ°: ${checked} äºº, æœªå ±åˆ°: ${unchecked} äºº, åƒèˆ‡ç‡: ${rate}%`;
todayInfo.className = 'note';
refreshCheckinMsg(); // â† æ–°å¢

        } else {
          // âš ï¸ ä¸æ˜¯ä»Šå¤© â†’ ç¶­æŒåŸæ¨£
          todayInfo.textContent = `(é€™ä¸æ˜¯ä»Šå¤©çš„èª²ç¨‹ï¼Œåƒ…ä¾›é è¦½ï¼Œä¸é–‹æ”¾å ±åˆ°)`;
todayInfo.className = 'note warn';
__allowCheckin = false;
setCheckinEnabled(false);

await loadStudentsAndAttendance();
refreshCheckinMsg(); // â† æ–°å¢

        }
        return;
      } else {
        // å¤šç­†èª²ç¨‹ â†’ ç¶­æŒåŸæ¨£
        const blank = document.createElement('option');
        blank.value = '';
        blank.textContent = 'è«‹é¸æ“‡èª²ç¨‹';
        selCourseToday.appendChild(blank);
        data.forEach(addOpt);

        todayInfo.textContent = `(è«‹é¸æ“‡èª²ç¨‹ï¼Œåƒ…å…è¨±ä»Šå¤© ${today} çš„èª²ç¨‹å ±åˆ°)`;
todayInfo.className = 'note warn';
__allowCheckin = false;
setCheckinEnabled(false);
refreshCheckinMsg(); // â† æ–°å¢
// ğŸ‘‡ æ–°å¢ï¼šå…ˆå–æ¶ˆä»»ä½•æ—¢æœ‰è¨‚é–±ï¼ˆé¿å…æ®˜ç•™ï¼‰
setupRealtimeAttendance(null);
return;

      }
    }

    // æ²’æœ‰ä»Šå¤©çš„èª² â†’ ä¸‹ä¸€å ‚èª²ç¶­æŒåŸæ¨£
    const next = await rest(`/rest/v1/courses?select=*&date=gt.${today}&order=date.asc,start_time.asc&limit=1`);
    if (Array.isArray(next) && next.length){
      const c = next[0];
      const t = c.start_time? `ï¼ˆ${c.start_time.slice(0,5)}~${(c.end_time||'').slice(0,5)}ï¼‰` : '';
      const opt = document.createElement('option');
      opt.value = c.id;
      opt.textContent = `${c.date} ${c.title} ${t}`;
      opt.dataset.date = c.date;
      selCourseToday.appendChild(opt);
      selCourseToday.value = c.id;

      todayInfo.textContent = `ä»Šå¤©æ²’æœ‰èª²ç¨‹ (åƒ…é è¦½åå–®, ä¸é–‹æ”¾å ±åˆ°)`;
todayInfo.className = 'note warn';

__allowCheckin = false;
setCheckinEnabled(false);
await loadStudentsAndAttendance();
refreshCheckinMsg(); // â† æ–°å¢

    }else{
      todayInfo.textContent = 'è¿‘æœŸæ²’æœ‰ä»»ä½•èª²ç¨‹ã€‚';
todayInfo.className = 'note warn';
$('#studentCards').innerHTML = '';
setCheckinEnabled(false);
refreshCheckinMsg(); // â† æ–°å¢

    }
  }catch(e){
    todayInfo.textContent = 'è®€å–ä»Šæ—¥/ä¸‹ä¸€æ¬¡èª²ç¨‹å¤±æ•—ï¼š' + e.message;
todayInfo.className='note danger';
refreshCheckinMsg(); // â† æ–°å¢ï¼šé¿å…æ®˜ç•™èˆŠè¨Šæ¯

  }
}


  // ===== å­¸å“¡åå–® + é»å¡ç‰‡å ±åˆ°ï¼ˆå¤–å±¤å”¯ä¸€ç‰ˆæœ¬ï¼‰=====
const studentCards       = $('#studentCards');
const studentSearch      = $('#studentSearch');
const btnReloadStudents  = $('#btnReloadStudents');

const inpEmp       = $('#inpEmp');
const btnCheckin   = $('#btnCheckin');
const btnClearEmp  = $('#btnClearEmp');
const checkinMsg   = $('#checkinMsg');

const selfCreateBox    = $('#selfCreateBox');
const inpTeam          = $('#inpTeam');
const inpName          = $('#inpName');
const inpEmp2          = $('#inpEmp2');
const btnCreateStudent = $('#btnCreateStudent');
const btnCancelCreate  = $('#btnCancelCreate');

let __studentsCache   = [];
let __checkedSet      = new Set();
let __currentCourseId = null;

// === æ–°å¢ï¼šåˆ†é ç‹€æ…‹ ===
const PAGE_SIZE = 10;
let __page = 1;
const studentPager = $('#studentPager');


// ğŸ‘‰ æŒ‰éˆ•èˆ‡è¼¸å…¥æ¡†ä¿æŒå¯ç”¨ï¼›æ˜¯å¦å…è¨±å ±åˆ°äº¤ç”± click handler çš„ __allowCheckin åˆ¤æ–·
function setCheckinEnabled(enabled){
  if (inpEmp)      inpEmp.disabled = !enabled;
  if (btnCheckin)  btnCheckin.disabled = !enabled;
  if (btnClearEmp) btnClearEmp.disabled = !enabled;
}


// ğŸ‘‰ è®“è¼¸å…¥æ¡†æŒ‰ Enter ä¹Ÿèƒ½è§¸ç™¼ã€Œç«‹å³å ±åˆ°ã€
// === å³æ™‚æ›´æ–°ä»Šæ—¥çµ±è¨ˆï¼ˆåƒ…ä»Šå¤©èª²ç¨‹æ‰é¡¯ç¤ºçµ±è¨ˆï¼‰===
// è¿½è¹¤ä¸Šä¸€æ¬¡çš„çµ±è¨ˆï¼Œç”¨ä¾†åˆ¤æ–·æ˜¯å¦æ’­æ”¾å‹•ç•«
let __prevStats = { checked: null, unchecked: null, rate: null };

function updateTodayStats(){
  const isToday = selCourseToday?.selectedOptions?.[0]?.dataset?.date === todayStr();
  if (!isToday) return;

  const total     = __studentsCache.length || 0;
  const checked   = __checkedSet.size || 0;
  const unchecked = Math.max(0, total - checked);
  const rate      = total > 0 ? Math.round((checked / total) * 100) : 0;

  // æ›´æ–°æ–‡å­—
  todayInfo.textContent = `å·²å ±åˆ°: ${checked} äºº, æœªå ±åˆ°: ${unchecked} äºº, åƒèˆ‡ç‡: ${rate}%`;
  todayInfo.className = 'note'; // ä¿æŒåŸºç¤æ¨£å¼ï¼ˆä»Šå¤©æ‰æ˜¯ç™½å­—ï¼‰

  // è‹¥çµ±è¨ˆæœ‰è®ŠåŒ–ï¼Œè§¸ç™¼å‹•ç•«ï¼ˆç§»é™¤â†’å¼·åˆ¶å›æµâ†’åŠ å› classï¼‰
  const changed = (
    __prevStats.checked   !== checked ||
    __prevStats.unchecked !== unchecked ||
    __prevStats.rate      !== rate
  );
  if (changed) {
    todayInfo.classList.remove('bump');
    void todayInfo.offsetWidth;      // å¼·åˆ¶å›æµä»¥é‡ç½®å‹•ç•«
    todayInfo.classList.add('bump'); // æ’­æ”¾å‹•ç•«
  }

  // è¨˜éŒ„é€™æ¬¡æ•¸å€¼
  __prevStats = { checked, unchecked, rate };

  refreshCheckinMsg(); // ä½ åŸæœ¬çš„è¡Œç‚ºï¼šåŒæ­¥è‡ªåŠ©å ±åˆ°ç‹€æ…‹
}

// === è‡ªå‹•åˆ·æ–°ä»Šæ—¥çµ±è¨ˆï¼ˆæ¯ 2 ç§’ï¼Œå«é˜²æŠ–æ©Ÿåˆ¶ï¼‰===
let __statsRefreshing = false;
setInterval(async ()=>{
  // åªè™•ç†ã€Œä»Šå¤©çš„èª²ç¨‹ã€æƒ…å¢ƒ
  const isToday = selCourseToday?.selectedOptions?.[0]?.dataset?.date === todayStr();
  if (!isToday) return;

  // å¦‚æœå‰ä¸€æ¬¡é‚„æ²’è·‘å®Œï¼Œå°±è·³é
  if (__statsRefreshing) return;
  __statsRefreshing = true;

  try {
    // é‡æ–°æ’ˆå‡ºæœ€æ–°å‡ºå¸­ç´€éŒ„
    const courseId = selCourseToday?.value;
    if (!courseId) return;

    const att = await rest(`/rest/v1/attendance?select=student_id&course_id=eq.${encodeURIComponent(courseId)}`);
    __checkedSet = new Set((att||[]).map(a=>a.student_id));

    // æ›´æ–°çµ±è¨ˆ
    updateTodayStats();
  } catch(e) {
    console.warn('çµ±è¨ˆåˆ·æ–°å¤±æ•—ï¼š', e);
  } finally {
    __statsRefreshing = false;
  }
}, 2000);  // â† é€™è£¡æ”¹æˆ 2 ç§’

// === åŒæ­¥è‡ªåŠ©å ±åˆ°æŒ‰éˆ•ä¸‹æ–¹ç‹€æ…‹ï¼ˆ#checkinMsgï¼‰ ===
function refreshCheckinMsg(){
  if (!checkinMsg) return;

  const hasCourse = !!selCourseToday?.value;
  const isToday = selCourseToday?.selectedOptions?.[0]?.dataset?.date === todayStr();

  if (!hasCourse) {
    checkinMsg.textContent = 'è«‹å…ˆé¸æ“‡èª²ç¨‹ã€‚';
    checkinMsg.className = 'note warn';
    return;
  }

  if (!isToday) {
    checkinMsg.textContent = 'éä»Šæ—¥èª²ç¨‹åƒ…ä¾›é è¦½åå–®ï¼Œç„¡æ³•å ±åˆ°ã€‚';
    checkinMsg.className = 'note warn';
    return;
  }

  // ä»Šå¤©çš„èª²ï¼šç¶­æŒä¹¾æ·¨ï¼ŒæˆåŠŸå ±åˆ°æ™‚å†ç”± doCheckin() è¨­ç‚ºç¶ è‰²è¨Šæ¯
  checkinMsg.textContent = '';
  checkinMsg.className = 'note';
}


inpEmp?.addEventListener('keydown', (e)=>{
  if (e.key === 'Enter') {
    e.preventDefault();
    btnCheckin?.click();
  }
});


selCourseToday?.addEventListener('change', async ()=>{
  const opt = selCourseToday.selectedOptions?.[0];
  const isToday = (opt?.dataset?.date === todayStr());
  __allowCheckin = !!isToday;
  setCheckinEnabled(__allowCheckin);

  refreshCheckinMsg(); // åˆ‡èª²æ™‚åŒæ­¥ç‹€æ…‹
  await loadStudentsAndAttendance();
  updateTodayStats();

  // åˆ‡èª²å°±æ”¹è¨‚é–±ç›®æ¨™
  setupRealtimeAttendance(selCourseToday?.value || null);
});


  btnReloadToday?.addEventListener('click', loadToday);

  async function loadStudentsAndAttendance(){
  studentCards.innerHTML = '';
  const courseId = selCourseToday?.value;
  __currentCourseId = courseId || null;
  if (!courseId) return;

  try{
    const students = await rest('/rest/v1/students?select=*&order=name.asc.nullslast&limit=1000');
    __studentsCache = Array.isArray(students)? students : [];
  }catch(e){
    const el=document.createElement('div'); el.className='note error';
    el.textContent='è®€å–å­¸å“¡å¤±æ•—ï¼š'+e.message; studentCards.appendChild(el); return;
  }

  __checkedSet = new Set();
  try{
    const att = await rest(`/rest/v1/attendance?select=student_id&course_id=eq.${encodeURIComponent(courseId)}`);
    (att||[]).forEach(a => __checkedSet.add(a.student_id));
  }catch(e){ /* ignore */ }

  __page = 1;          // â† æ–°å¢ï¼šæ¯æ¬¡é‡è¼‰å›åˆ°ç¬¬ 1 é 
renderStudentCards();
updateTodayStats();      // â† è¼‰å…¥å®Œæˆå¾Œæ›´æ–°çµ±è¨ˆ
refreshCheckinMsg();     // â† æ–°å¢ï¼šåå–®è¼‰å®Œï¼ŒåŒæ­¥è‡ªåŠ©å ±åˆ°å€ç‹€æ…‹
}
/* ===== Realtimeï¼šattendance è®Šæ›´å³æ™‚æ›´æ–°ï¼ˆå”¯ä¸€ç‰ˆæœ¬ï¼‰===== */
let __rtChannel = null;
let __rtDebounce = null;

// å°é˜²æŠ–ï¼šä½µæµå…©å´åŒæ™‚å ±åˆ°çš„ç¬æ™‚å¤šäº‹ä»¶ï¼Œ120ms å¾Œåªåˆ·æ–°ä¸€æ¬¡
function scheduleRealtimeRefresh(){
  clearTimeout(__rtDebounce);
  __rtDebounce = setTimeout(()=>{
    loadStudentsAndAttendance().catch(()=>{});
  }, 120);
}

// ä¾ç›®å‰èª²ç¨‹ id è¨‚é–±/é‡è¨‚é–±
async function setupRealtimeAttendance(courseId){
  try{
    // å…ˆå–æ¶ˆèˆŠçš„
    if (__rtChannel){
      await sb.removeChannel(__rtChannel);
      __rtChannel = null;
    }
    if (!courseId) return;

    // åªè½ç•¶å‰èª²ç¨‹çš„ç•°å‹•
    __rtChannel = sb
      .channel(`attendance-${courseId}`)
      .on(
        'postgres_changes',
        {
          event: '*',          // INSERT/UPDATE/DELETE
          schema: 'public',
          table: 'attendance',
          filter: `course_id=eq.${courseId}`
        },
        () => {
          // æœ‰è®Šæ›´ â†’ é‡æ–°æ’ˆåå–® + çµ±è¨ˆï¼ˆç”¨é˜²æŠ–é¿å…æŠ–å‹•ï¼‰
          scheduleRealtimeRefresh();
        }
      )
      .subscribe();
  }catch(e){
    console.error('setupRealtimeAttendance å¤±æ•—ï¼š', e);
  }
}

    function getFilteredStudents(){
  const q = (studentSearch?.value || '').trim().toLowerCase();
  let list = __studentsCache;

  if (q){
    list = list.filter(s =>
      (s.team||'').toLowerCase().includes(q) ||
      (s.name||'').toLowerCase().includes(q) ||
      (s.employee_no||'').toLowerCase().includes(q)
    );
  }

  const collator = new Intl.Collator('en', { sensitivity: 'base' });
  list = list.slice().sort((a,b)=>{
    const byName = collator.compare(a.name||'', b.name||'');
    if (byName !== 0) return byName;
    return collator.compare(a.employee_no||'', b.employee_no||'');
  });

  return list;
}

function renderPager(totalPages, totalItems){
  if (!studentPager) return;
  studentPager.innerHTML = '';

  // å»ºç«‹æŒ‰éˆ•/æ–‡å­—çš„å°å·¥å…·
  const mkBtn = (html, disabled, onClick) => {
  const b = document.createElement('button');
  b.className = 'icon-btn';   // æ›æˆä½ å‰é¢å®šç¾©å¥½çš„åœ“å½¢æŒ‰éˆ•æ¨£å¼
  b.innerHTML = html;         // â† ç”¨ innerHTML æ”¾ SVG
  b.disabled = !!disabled;
  b.addEventListener('click', onClick);
  return b;
};

  const mkInfo = (text) => {
    const span = document.createElement('span');
    span.className = 'note';
    span.textContent = text;
    return span;
  };

  // Prev
// Prev â† å·¦ç®­é ­åœ–ç¤º
studentPager.appendChild(mkBtn(
  `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
     <polyline points="15 18 9 12 15 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
   </svg>`,
  __page <= 1,
  ()=>{
    __page = Math.max(1, __page - 1);
    renderStudentCards();
  }
));

// é ç¢¼è³‡è¨Š
studentPager.appendChild(mkInfo(`ç¬¬ ${__page} / ${totalPages} é ï¼ˆå…± ${totalItems} ç­†ï¼‰`));

// Next â†’ å³ç®­é ­åœ–ç¤º
studentPager.appendChild(mkBtn(
  `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
     <polyline points="9 18 15 12 9 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
   </svg>`,
  __page >= totalPages,
  ()=>{
    __page = Math.min(totalPages, __page + 1);
    renderStudentCards();
  }
));

}

function renderStudentCards(){
  const all = getFilteredStudents();

  const totalItems = all.length;
  const totalPages = Math.max(1, Math.ceil(totalItems / PAGE_SIZE));

  // è‹¥ç›®å‰é è¶…å‡ºç¯„åœï¼Œè‡ªå‹•æ‹‰å›æœ‰æ•ˆé 
  if (__page > totalPages) __page = totalPages;
  if (__page < 1) __page = 1;

  const start = (__page - 1) * PAGE_SIZE;
  const pageItems = all.slice(start, start + PAGE_SIZE);

  studentCards.innerHTML = '';

  if (!pageItems.length){
    const el=document.createElement('div'); el.className='note';
    el.textContent = (studentSearch?.value || '').trim() ? 'æ²’æœ‰ç¬¦åˆæœå°‹çš„å­¸å“¡' : 'å°šæœªåŒ¯å…¥å­¸å“¡åå–®';
    studentCards.appendChild(el);
    renderPager(totalPages, totalItems);
    return;
  }

  pageItems.forEach(s=>{
    const card=document.createElement('div');
    card.className='card-item' + ( __checkedSet.has(s.id)? ' checked':'' );
    card.dataset.sid = s.id;
    card.innerHTML = `
      <div class="row-top">
        <div class="avatar">${escapeHtml(getInitials(s.name, s.employee_no))}</div>
        <div style="margin-left:6px"><b>${escapeHtml(s.name||'')}</b></div>
        ${__checkedSet.has(s.id) ? '<span class="chip-ok" style="margin-left:auto">å·²å ±åˆ°</span>' : ''}
      </div>`;

    card.addEventListener('click', async ()=>{
      if (!__currentCourseId){ alert('è«‹å…ˆé¸æ“‡èª²ç¨‹'); return; }
      if (!__allowCheckin){
        alert('é€™å ‚èª²ä¸æ˜¯ä»Šå¤©ï¼Œåƒ…ä¾›é è¦½åå–®ï¼Œç„¡æ³•å ±åˆ°');
        return;
      }
      try{
        await doCheckin(__currentCourseId, s);
    // ğŸ‘‡ æ–°å¢ï¼šå»£æ’­é€šçŸ¥
    emitCheckin(__currentCourseId, s.id);

        __checkedSet.add(s.id);
        card.classList.add('checked');
        if (!card.querySelector('.chip-ok')){
          const ok=document.createElement('span');
          ok.className='chip-ok'; ok.textContent='å·²å ±åˆ°'; ok.style.marginLeft='auto';
          card.querySelector('.row-top').appendChild(ok);
        }
        updateTodayStats(); // â† æ–°å¢ï¼šé»åç‰‡æˆåŠŸå³æ™‚æ›´æ–°çµ±è¨ˆ

      }catch(e){ alert('å ±åˆ°å¤±æ•—ï¼š' + (e?.message || e)); }

    });

    studentCards.appendChild(card);
  });

  renderPager(totalPages, totalItems);
}


// é‡æ–°è¼‰å…¥å­¸å“¡ï¼šå›åˆ°ç¬¬ 1 é å¾Œå†è¼‰
btnReloadStudents?.addEventListener('click', async ()=>{
  __page = 1;  // æ¯æ¬¡é‡è¼‰å›åˆ°ç¬¬ä¸€é 
  await loadStudentsAndAttendance();
});

// æœå°‹ï¼šå›åˆ°ç¬¬ 1 é ä¸¦é‡æ–°æ¸²æŸ“ï¼ˆä¸éœ€è¦é‡æ’ˆè³‡æ–™ï¼Œç”¨å¿«å–å³å¯ï¼‰
studentSearch?.addEventListener('input', ()=>{
  __page = 1;
  renderStudentCards();
});

// æ¸…é™¤è¼¸å…¥æ¡†
btnClearEmp?.addEventListener('click', ()=>{
  if(inpEmp) inpEmp.value='';
  if(checkinMsg){ checkinMsg.textContent=''; checkinMsg.className='note'; }
  selfCreateBox?.classList.add('hide');
});

// âœ… ã€ŒAddã€æŒ‰éˆ•ï¼šä»¥ Team / Name / ID é—œéµå­—æœå°‹ï¼›0 ç­†æ‰é¡¯ç¤ºè‡ªåŠ©å»ºç«‹
btnCheckin?.addEventListener('click', async ()=>{
  // è‹¥ä¸æ˜¯ä»Šå¤©çš„èª²ï¼Œä¿ç•™åŸæœ¬é˜»æ“‹é‚è¼¯ï¼ˆä½†æŒ‰éˆ•ä»å¯é»ï¼Œæœƒé¡¯ç¤ºæç¤ºï¼‰
  if (!__allowCheckin){
    checkinMsg.textContent='éä»Šæ—¥èª²ç¨‹åƒ…ä¾›é è¦½åå–®ï¼Œç„¡æ³•å ±åˆ°ã€‚';
    checkinMsg.className='note warn';
    return;
  }

  const course_id = selCourseToday?.value;
  const kw = (inpEmp?.value || '').trim();
  if (!course_id){ checkinMsg.textContent='è«‹å…ˆé¸æ“‡èª²ç¨‹ã€‚'; checkinMsg.className='note warn'; return; }
  if (!kw){ checkinMsg.textContent='è«‹è¼¸å…¥é—œéµå­—ï¼ˆTeam / Name / IDï¼‰ã€‚'; checkinMsg.className='note warn'; return; }

  try{
    // ä»¥ Team/Name/ID æ¨¡ç³Šæœå°‹ï¼ˆPostgREST or=ï¼‰
    // ä¾‹ï¼š/students?select=*&or=(team.ilike.*kw*,name.ilike.*kw*,employee_no.ilike.*kw*)&order=name.asc
    const like = (s)=> `*${encodeURIComponent(s)}*`;
    const orExpr = `or=(team.ilike.${like(kw)},name.ilike.${like(kw)},employee_no.ilike.${like(kw)})`;
    const url = `/rest/v1/students?select=*&${orExpr}&order=name.asc.nullslast&limit=50`;
    const rows = await rest(url);

    // æ ¹æ“šçµæœæ•¸é‡æ±ºå®šæµç¨‹
    if (Array.isArray(rows) && rows.length === 1){
  await doCheckin(course_id, rows[0]);
  // ğŸ‘‡ æ–°å¢ï¼šå»£æ’­é€šçŸ¥
  emitCheckin(course_id, rows[0].id);

  // æ¨‚è§€æ›´æ–°ï¼šæœ¬åœ°é›†åˆ + ç•«é¢ï¼ˆè‹¥å¡ç‰‡åœ¨ç•¶å‰é é¢ï¼‰
  __checkedSet.add(rows[0].id);
  const card = studentCards?.querySelector(`[data-sid="${rows[0].id}"]`);
  if (card && !card.classList.contains('checked')){
    card.classList.add('checked');
    if (!card.querySelector('.chip-ok')){
      const ok = document.createElement('span');
      ok.className = 'chip-ok'; ok.textContent = 'å·²å ±åˆ°'; ok.style.marginLeft = 'auto';
      card.querySelector('.row-top')?.appendChild(ok);
    }
  }

  updateTodayStats(); // å³ä¸Šçµ±è¨ˆç«‹åˆ»æ›´æ–°

  // æ¸…ç† UIï¼ˆä¸ç«‹åˆ»é‡æ’ˆï¼Œé¿å…èˆŠè³‡æ–™è¦†è“‹ï¼‰
  if (inpEmp) inpEmp.value='';
  selfCreateBox?.classList.add('hide');

  // å¦‚æœä½ çœŸçš„æƒ³é‡æ’ˆï¼Œå†åŠ é€™ä¸€è¡Œï¼ˆå¯é¸ï¼‰ï¼šç¨å¾®å»¶å¾Œï¼Œé¿é–‹å¯«å…¥/è®€å–å»¶é²
  // setTimeout(() => loadStudentsAndAttendance(), 500);

  return;
}


    if (Array.isArray(rows) && rows.length > 1){
      // å¤šç­† â†’ ä¸è‡ªå‹•å ±åˆ°ï¼›è«‹ç”¨å·¦å´åç‰‡é»æ“Šå ±åˆ°ï¼ˆé¿å…å ±éŒ¯äººï¼‰
      checkinMsg.textContent = `æ‰¾åˆ° ${rows.length} ç­†ï¼Œè«‹åœ¨å·¦å´åå–®é»é¸æ­£ç¢ºå­¸å“¡å®Œæˆå ±åˆ°ã€‚`;
      checkinMsg.className = 'note';
      selfCreateBox?.classList.add('hide');
      return;
    }

    // 0 ç­† â†’ é¡¯ç¤ºã€Œè‡ªåŠ©å»ºç«‹å­¸å“¡ã€
    selfCreateBox?.classList.remove('hide');
    if (inpEmp2) inpEmp2.value = kw;   // é å¡«ä½¿ç”¨è€…å‰›è¼¸å…¥çš„ ID/é—œéµå­—
    if (checkinMsg){
      checkinMsg.textContent='æ‰¾ä¸åˆ°æ­¤é—œéµå­—çš„å­¸å“¡ï¼Œè«‹å¡« Team / å§“å / ID å¾ŒæŒ‰ã€Œå»ºç«‹ä¸¦å ±åˆ°ã€ã€‚';
      checkinMsg.className='note warn';
    }
  }catch(e){
    checkinMsg.textContent='æŸ¥è©¢å­¸å“¡å¤±æ•—ï¼š'+(e?.message||e);
    checkinMsg.className='note error';
  }
});


  btnCreateStudent?.addEventListener('click', async()=>{
  const team=(inpTeam?.value||'').trim(), name=(inpName?.value||'').trim(), emp=(inpEmp2?.value||'').trim();
  const course_id = selCourseToday?.value;

  if (!__allowCheckin){ alert('é€™å ‚èª²ä¸æ˜¯ä»Šå¤©ï¼Œåƒ…ä¾›é è¦½åå–®ï¼Œç„¡æ³•å ±åˆ°'); return; }
  if (!team || !name || !emp){ alert('Team/å§“å/å·¥è™Ÿä¸å¯ç‚ºç©º'); return; }

  try{
    // è¦æ±‚ PostgREST å›å‚³å‰›æ’å…¥çš„è³‡æ–™
    let ins = await rest('/rest/v1/students?select=*', {
      method:'POST',
      headers: { 'Prefer': 'return=representation' },
      body: JSON.stringify({ team, name, employee_no: emp })
    });

    // å…¼å®¹å›å‚³å‹æ…‹ï¼šå¯èƒ½æ˜¯é™£åˆ—æˆ–ç‰©ä»¶ï¼›ä¹Ÿå¯èƒ½ç‚º nullï¼ˆæŸäº›è¨­å®šï¼‰
    let created = Array.isArray(ins) ? ins[0] : ins;

    // å¦‚æœä»æ‹¿ä¸åˆ°ï¼Œåšä¸€æ¬¡ fallback æŸ¥è©¢ï¼ˆä»¥ employee_no æ’ˆï¼‰
    if (!created?.id) {
      const rows = await rest('/rest/v1/students?select=*&employee_no=eq.' + encodeURIComponent(emp));
      created = Array.isArray(rows) ? rows[0] : rows;
    }

    if (!created?.id) {
      throw new Error('å»ºç«‹å­¸å“¡å¾Œç„¡æ³•å–å¾— idï¼ˆå¯èƒ½æ˜¯ RLS æˆ–å›å‚³è¨­å®šå•é¡Œï¼‰');
    }

    await doCheckin(course_id, created);

    __checkedSet.add(created.id); // â† æ–°å¢
    updateTodayStats();           // â† æ–°å¢

    // UI æ¸…ç†
    selfCreateBox?.classList.add('hide');

    if (inpTeam) inpTeam.value=''; if (inpName) inpName.value=''; if (inpEmp2) inpEmp2.value='';


  }catch(e){
    alert('å»ºç«‹å­¸å“¡å¤±æ•—ï¼š' + (e?.message||e));
  }
});

  btnCancelCreate?.addEventListener('click', ()=>{
    selfCreateBox?.classList.add('hide');
    if (inpTeam) inpTeam.value=''; if (inpName) inpName.value=''; if (inpEmp2) inpEmp2.value='';
    if (checkinMsg){ checkinMsg.textContent='å·²å–æ¶ˆè‡ªåŠ©å»ºç«‹ã€‚'; checkinMsg.className='note'; }
  });

  async function doCheckin(course_id, student){
  if (!__allowCheckin) throw new Error('éä»Šæ—¥èª²ç¨‹ä¸å…è¨±å ±åˆ°');
  if (!student || !student.id) throw new Error('æ‰¾ä¸åˆ°å­¸å“¡è³‡æ–™ï¼ˆstudent.id ç‚ºç©ºï¼‰');

  try{
    await rest('/rest/v1/attendance', {
      method:'POST',
      body: JSON.stringify({ course_id, student_id: student.id, user_agent: navigator.userAgent })
    });
await rest('/rest/v1/attendance', {
  method:'POST',
  body: JSON.stringify({ course_id, student_id: student.id, user_agent: navigator.userAgent })
});

// ğŸ‘‡ æ–°å¢ï¼šå»£æ’­é€šçŸ¥åˆ¥çš„è£ç½®
emitCheckin(course_id, student.id);

    if (checkinMsg){
      checkinMsg.textContent='å ±åˆ°æˆåŠŸï¼ç¥ä¸Šèª²é †åˆ© ğŸ‰';
      checkinMsg.className='note ok';
    }
    if (inpEmp) inpEmp.value='';
    return { ok:true, duplicated:false };

  }catch(e){
    const msg = String(e?.message || '');
    // âœ… å°‡ã€Œé‡è¤‡ã€ç•¶ä½œå·²å ±åˆ°çš„æˆåŠŸï¼š409 æˆ– unique violation è¨Šæ¯
    if (e?.status === 409 || /duplicate key|unique|ux_attendance_unique_day_local/i.test(msg)){
      if (checkinMsg){
        checkinMsg.textContent='æ­¤å­¸å“¡å·²å ±åˆ°ï¼Œå·²ç‚ºä½ ç•¥éé‡è¤‡ã€‚';
        checkinMsg.className='note';
      }
      if (inpEmp) inpEmp.value='';
      return { ok:true, duplicated:true };
    }
    // å…¶ä»–éŒ¯èª¤æ‰å¾€å¤–æ‹‹
    throw e;
  }
}



  // ===== å¾Œå°ï¼šèª²ç¨‹ CRUDï¼ˆéœ€ç™»å…¥ï¼‰=====
  const listCourses=$('#listCourses'), courseMsg=$('#courseMsg');
  async function loadCourses(){
    listCourses.innerHTML = '';
    if (!state.access_token){ courseMsg.textContent='è«‹å…ˆåœ¨ã€ç™»å…¥ã€‘åˆ†é å®Œæˆç™»å…¥ã€‚'; courseMsg.className='note warn'; return; }
    try{
      const data = await rest('/rest/v1/courses?select=*&order=date.desc&limit=50', { auth:true });
      if (!data?.length){ courseMsg.textContent='å°šç„¡èª²ç¨‹'; courseMsg.className='note warn'; return; }
      courseMsg.textContent = `æœ€è¿‘ ${data.length} é–€èª²ç¨‹ï¼š`; courseMsg.className='note';
      data.forEach(c=>{
        const t = c.start_time? `ï¼ˆ${(c.start_time||'').slice(0,5)}~${(c.end_time||'').slice(0,5)}ï¼‰` : '';
        const item = document.createElement('div');
        item.className='item'; item.dataset.id=c.id;
        item.innerHTML = `
          <div><b>${escapeHtml(c.title||'')}</b>ï½œ<span class="muted">${c.date||''}${t}</span></div>
          <div class="row">
            <button class="ghost btn-edit" title="ç·¨è¼¯">ç·¨è¼¯</button>
            <button class="ghost btn-delete" title="åˆªé™¤">åˆªé™¤</button>
          </div>`;
        listCourses.appendChild(item);
      });
    }catch(e){ courseMsg.textContent='è®€å–èª²ç¨‹å¤±æ•—ï¼š' + e.message; courseMsg.className='note error'; }
  }

  $('#btnLoadCourses')?.addEventListener('click', loadCourses);
  $('#btnCreateCourse')?.addEventListener('click', async()=>{
    const title = ($('#inpTitle')?.value || '').trim(), date=$('#inpDate')?.value;
    if (!title || !date){ courseMsg.textContent='èª²ç¨‹åç¨±èˆ‡æ—¥æœŸç‚ºå¿…å¡«'; courseMsg.className='note warn'; return; }
    const start_time=$('#inpStart')?.value||null, end_time=$('#inpEnd')?.value||null, description=$('#inpDesc')?.value||null;
    try{
      await rest('/rest/v1/courses?select=*', { method:'POST', auth:true, body: JSON.stringify({ title, date, start_time, end_time, description }) });
      courseMsg.textContent='èª²ç¨‹å»ºç«‹æˆåŠŸ'; courseMsg.className='note ok';
      $('#inpTitle').value=''; $('#inpDate').value=''; $('#inpStart').value=''; $('#inpEnd').value=''; $('#inpDesc').value='';
      loadCourses(); loadToday(); loadStackedChart();
    }catch(e){ courseMsg.textContent='å»ºç«‹èª²ç¨‹å¤±æ•—ï¼š' + e.message; courseMsg.className='note error'; }
  });

  listCourses?.addEventListener('click', (ev)=>{
    const btn = ev.target.closest('button'); if (!btn) return;
    const item = ev.target.closest('div.item'); const id = item?.dataset?.id; if (!id) return;
    if (btn.classList.contains('btn-edit')) editCourse(id);
    if (btn.classList.contains('btn-delete')) deleteCourse(id);
  });

  async function editCourse(id){
    try{
      const rows = await rest(`/rest/v1/courses?select=*&id=eq.${encodeURIComponent(id)}`, { auth:true });
      const c = rows?.[0]; if (!c){ alert('æ‰¾ä¸åˆ°èª²ç¨‹'); return; }
      const title = prompt('èª²ç¨‹åç¨±ï¼š', c.title || ''); if (title===null) return;
      const date = prompt('æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰ï¼š', c.date || ''); if (date===null) return;
      const start_time = prompt('é–‹å§‹æ™‚é–“ï¼ˆHH:MMï¼Œå¯ç©ºï¼‰ï¼š', (c.start_time||'').slice(0,5)); if (start_time===null) return;
      const end_time = prompt('çµæŸæ™‚é–“ï¼ˆHH:MMï¼Œå¯ç©ºï¼‰ï¼š', (c.end_time||'').slice(0,5)); if (end_time===null) return;
      const description = prompt('èªªæ˜ï¼ˆå¯ç©ºï¼‰ï¼š', c.description || ''); if (description===null) return;
      const body = {
        title, date,
        start_time: start_time? (start_time+':00'): null,
        end_time: end_time? (end_time+':00'): null,
        description: description || null
      };
      await rest(`/rest/v1/courses?id=eq.${encodeURIComponent(id)}`, { method:'PATCH', auth:true, body: JSON.stringify(body) });
      await loadCourses(); await loadToday(); await loadStackedChart();
    }catch(e){ alert('æ›´æ–°å¤±æ•—ï¼š' + e.message); }
  }
  async function deleteCourse(id){
  if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤èª²ç¨‹å—ï¼Ÿåˆªé™¤å¾Œï¼Œç›¸é—œå ±åˆ°è¨˜éŒ„ä¹Ÿæœƒè¢«ç§»é™¤ã€‚')) return;
  try{
    await rest(`/rest/v1/courses?id=eq.${encodeURIComponent(id)}`, { method:'DELETE', auth:true });
    await loadCourses();
    await loadStackedChart();
    // ğŸ”„ åŒæ­¥åˆ·æ–°ã€Œå­¸å“¡å ±åˆ°ã€é çš„èª²ç¨‹/åå–®ï¼ˆå¦‚æœç›®å‰æ­£åœåœ¨å­¸å“¡å ±åˆ°ä¹Ÿæœƒæ›´æ–°ï¼‰
    try{ await loadToday(); }catch{}
  }catch(e){
    alert('åˆªé™¤å¤±æ•—ï¼š' + (e?.message || e));
  }
}

  // ===== åœ–è¡¨ï¼ˆTeam å †ç–Š + ç¸½æ•¸ç™½è‰²ç·š + æ¨™ç±¤ï¼‰=====
  let chart;
  const btnExportAttend = $('#btnExportAttend');
  btnExportAttend?.addEventListener('click', exportAttendanceCSV);

  function clearChart(){ if (chart){ chart.destroy(); chart=null; } }

 /* ğŸ‘‡ æ–°å¢ï¼šåªå°æŸ±ç‹€åœ–åŠ é™°å½±çš„ pluginï¼ˆé¿å…å½±éŸ¿ç™½ç·š Totalï¼‰ */
const shadowPlugin = {
  id: 'shadowPlugin',
  beforeDatasetDraw(chart, args) {
    const ds   = chart.config.data.datasets[args.index];
    const type = ds.type || chart.config.type;
    const isBar = type === 'bar';
    if (isBar) {
      const { ctx } = chart;
      ctx.save();
      ctx.shadowColor   = 'rgba(0,0,0,0.45)';
      ctx.shadowBlur    = 12;
      ctx.shadowOffsetX = 0;
      ctx.shadowOffsetY = 6;
    }
  },
  afterDatasetDraw(chart, args) {
    const ds   = chart.config.data.datasets[args.index];
    const type = ds.type || chart.config.type;
    const isBar = type === 'bar';
    if (isBar) chart.ctx.restore();
  }
};
 
/* ğŸ‘‡ å–ä»£åŸæœ¬çš„ bringTotalToFrontPluginï¼šç”¨ controller.draw() å®Œæ•´é‡ç¹ªåˆ°æœ€ä¸Šå±¤ */
const bringTotalToFrontPlugin = {
  id: 'bringTotalToFrontPlugin',
  afterDatasetsDraw(chart) {
    // æ‰¾åˆ° isTotal çš„è³‡æ–™é›†ç´¢å¼•
    const dsIndex = chart.data.datasets.findIndex(d => d && d.isTotal);
    if (dsIndex < 0) return;

    const meta = chart.getDatasetMeta(dsIndex);
    if (!meta || meta.hidden) return;

    const { ctx } = chart;
    ctx.save();
    // é—œé–‰é™°å½±ï¼Œä»¥å…å—æŸ±ç‹€é™°å½±å½±éŸ¿
    ctx.shadowColor = 'transparent';
    ctx.shadowBlur = 0;
    ctx.globalCompositeOperation = 'source-over';

    // âœ… ç”¨ controller.draw() é‡æ–°æŠŠæ•´å€‹è³‡æ–™é›†ï¼ˆç·šï¼‹é»ï¼‰ç•«åˆ°æœ€ä¸Šå±¤
    if (meta.controller && typeof meta.controller.draw === 'function') {
      meta.controller.draw();
    } else if (meta.dataset && typeof meta.dataset.draw === 'function') {
      // å¾Œå‚™ï¼šä»å˜—è©¦ç›´æ¥ç•« dataset/pointsï¼ˆè¼ƒä¸ä¿éšªï¼Œä½†ä¿ç•™ï¼‰
      meta.dataset.draw(ctx);
      Array.isArray(meta.data) && meta.data.forEach(el => el && el.draw && el.draw(ctx));
    }

    ctx.restore();
  }
};


  // åœ¨ Total çš„æ¯å€‹é»ä¸Šæ–¹é¡¯ç¤ºæ•¸å€¼
  const valueLabelPlugin = {
    id: 'valueLabelPlugin',
    afterDatasetsDraw(chart) {
      const { ctx } = chart;
      ctx.save();
      ctx.shadowColor = 'transparent';
      ctx.shadowBlur = 0;
      ctx.beginPath(); ctx.rect(0, 0, ctx.canvas.width, ctx.canvas.height); ctx.clip();
      ctx.globalCompositeOperation = 'source-over';
      ctx.fillStyle = '#ffffff';
      ctx.font = '12px system-ui, -apple-system, Segoe UI, Microsoft JhengHei, sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'bottom';
      chart.data.datasets.forEach((ds, dsIndex) => {
        if (!ds.isTotal) return;
        const meta = chart.getDatasetMeta(dsIndex);
        meta.data.forEach((pt, i) => {
          const val = ds.data[i];
          if (val > 0) {
            const { x, y } = pt.getProps(['x','y'], true);
            ctx.fillText(String(val), x, y - 6);
          }
        });
      });
      ctx.restore();
    }
  };

  async function exportAttendanceCSV(){
    if (!state.access_token){ alert('è«‹å…ˆç™»å…¥å¾Œå†åŒ¯å‡º'); return; }
    try{
      const headers = { 'apikey': SUPABASE_ANON_KEY, 'Authorization':'Bearer ' + state.access_token, 'Accept':'application/json' };
      const resCourses = await fetch(`${SUPABASE_URL}/rest/v1/courses?select=id,title,date&order=date.asc&limit=2000`, { headers });
      const courses = await resCourses.json();
      const courseMap = new Map((courses||[]).map(c=> [c.id, c]));

      const resAtt = await fetch(`${SUPABASE_URL}/rest/v1/attendance?select=course_id,student_id&limit=50000`, { headers });
      const att = await resAtt.json();
      if (!att?.length){ alert('æ²’æœ‰å¯åŒ¯å‡ºçš„å‡ºå¸­è³‡æ–™'); return; }

      const resStu = await fetch(`${SUPABASE_URL}/rest/v1/students?select=id,team,name,employee_no&limit=20000`, { headers });
      const stuRows = await resStu.json();
      const id2stu = new Map((stuRows||[]).map(s=> [s.id, s]));

      const records = (att||[]).map(r=>{
        const c = courseMap.get(r.course_id);
        const s = id2stu.get(r.student_id) || {};
        return {
          date:  c?.date  || '',
          title: c?.title || '',
          team:  s.team || '',
          name:  s.name || '',
          id:    s.employee_no || ''
        };
      }).sort((a,b)=>
        a.date.localeCompare(b.date) ||
        a.title.localeCompare(b.title) ||
        a.team.localeCompare(b.team) ||
        a.name.localeCompare(b.name)
      );

      const esc = s => `"${String(s??'').replace(/"/g,'""')}"`;
      const csv = 'Date,Course,Team,Name,ID\n' +
                  records.map(r=> [r.date,r.title,r.team,r.name,r.id].map(esc).join(',')).join('\n');

      const blob = new Blob(["\uFEFF" + csv], { type:'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'attendance_list.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    }catch(e){
      alert('åŒ¯å‡ºå¤±æ•—ï¼š' + (e?.message || e));
    }
  }

  async function loadStackedChart(){
    if (!state.access_token) return;

    await ensureChartJs();

    const ChartCtor = (typeof Chart === 'function') ? Chart : (window.Chart?.Chart || window.Chart);
    if (!ChartCtor || typeof ChartCtor !== 'function'){
      console.error('Chart.js not ready:', window.Chart);
      return;
    }

    const canvas = document.getElementById('chart');
    if (!canvas) return;

    if ((canvas.offsetWidth || canvas.getBoundingClientRect().width) <= 0){
      requestAnimationFrame(loadStackedChart);
      return;
    }

    function setMsg(txt){
      let m = document.getElementById('chartMsg');
      if (!m){ m = document.createElement('div'); m.id='chartMsg'; m.className='note'; m.style.marginTop='6px'; canvas.parentNode.insertBefore(m, canvas.nextSibling); }
      m.textContent = txt || '';
    }
    setMsg('è¼‰å…¥è³‡æ–™ä¸­â€¦');

    try{
      const courses = await rest('/rest/v1/courses?select=id,title,date&order=date.asc', { auth:true });
      if (!Array.isArray(courses) || !courses.length){ clearChart(); setMsg('ç›®å‰æ²’æœ‰èª²ç¨‹å¯é¡¯ç¤º'); return; }

      const attends = await rest('/rest/v1/attendance?select=course_id,student_id', { auth:true });
      const stuRows = await rest('/rest/v1/students?select=id,team&limit=20000', { auth:true });
      const id2team = new Map((stuRows||[]).map(s => [s.id, s.team || 'æœªåˆ†é¡']));

      const labelByCourse = new Map(), labels=[];
      courses.forEach(c=>{ const lab=`${c.date} ${c.title}`; labelByCourse.set(c.id, lab); labels.push(lab); });

      const teamSet = new Set(), counts = {}, uniq = {};
      function ensureTeam(t){ if(!counts[t]) counts[t]={}; teamSet.add(t); }

      (attends||[]).forEach(r=>{
        const lab = labelByCourse.get(r.course_id); if (!lab) return;
        const team = id2team.get(r.student_id) || 'æœªåˆ†é¡';
        ensureTeam(team);
        const key = `${team}::${r.course_id}::${r.student_id}`;
        if (!uniq[key]){ uniq[key]=true; counts[team][lab] = (counts[team][lab]||0) + 1; }
      });

      const datasets = [];
      const sortedTeams = Array.from(teamSet).sort();
      const palette = ['#418ab3','#a6b727','#f69200','#fec000','#ff9999'];

      sortedTeams.forEach((team, i)=>{
        datasets.push({
          type: 'bar',
          label: team,
          data: labels.map(l => counts[team]?.[l] || 0),
          backgroundColor: palette[i % palette.length],
          borderColor:     palette[i % palette.length],
          borderWidth: 1,
          order: 1
        });
      });

      const totals = labels.map(lab => sortedTeams.reduce((s,t)=> s + (counts[t]?.[lab]||0), 0));
      datasets.push({
  type: 'line',
  label: 'Total',
  data: totals,
  borderColor: '#ffffff',
  backgroundColor: '#ffffff',
  borderWidth: 3,
  tension: 0.35,
  pointRadius: 3,
  pointHoverRadius: 5,
  pointBackgroundColor: '#ffffff',
  pointBorderColor: '#ffffff',
  borderCapStyle: 'round',     // â† å¯é¸ï¼šç·šç«¯é»æ›´åœ“
  borderJoinStyle: 'round',    // â† å¯é¸ï¼šæŠ˜ç·šè½‰è§’æ›´åœ“
  fill: false,
  yAxisID: 'y',
  order: 9999,
  clip: false,
  isTotal: true
});



      const yMax = Math.max(0, ...totals) + 6;

      clearChart();
      const ctx = canvas.getContext('2d');
      chart = new ChartCtor(ctx, {
        type: 'bar',
        data: { labels, datasets },
        options: {
          responsive: true,
          animation: { duration: 0 },
          scales: {
            x: {
              stacked: true,
              ticks: {
                color: '#cfd5e3',
                callback: function(value, index){
                  const full = this.chart?.data?.labels?.[index] ?? '';
                  const m = /(\d{4})-(\d{2})-(\d{2})/.exec(full);
                  return m ? (parseInt(m[2],10) + '/' + parseInt(m[3],10)) : full;
                }
              }
            },
            y: {
              stacked: true,
              beginAtZero: true,
              max: yMax,
              grid: {
                color: 'rgba(255,255,255,0.4)',
                borderColor: 'rgba(255,255,255,0.4)',
                tickColor: 'rgba(255,255,255,0.4)'
              },
              ticks: { color: '#cfd5e3' }
            }
          },
plugins: { 
legend:{
position: 'bottom',          // ğŸ‘ˆ åœ–ä¾‹æ”¹åˆ°ä¸‹æ–¹
labels:{ color:'#cfd5e3' }
} 
}
},
plugins: [shadowPlugin, bringTotalToFrontPlugin, valueLabelPlugin]

});

      setMsg('');
    }catch(e){
      clearChart();
      setMsg('åœ–è¡¨è¼‰å…¥å¤±æ•—ï¼š' + (e?.message || e));
      console.error(e);
    }
  }

  // åªåŒ¯å‡ºã€Œä»Šå¤©ã€èª²ç¨‹çš„å‡ºå¸­åå–®ï¼ˆå‚™ç”¨ï¼‰
  async function exportTodayAttendance(){
    if (!state.access_token){ alert('è«‹å…ˆç™»å…¥å¾Œå†åŒ¯å‡º'); return; }
    const today = todayStr();

    const courses = await rest(`/rest/v1/courses?select=id,title,date,start_time,end_time&date=eq.${today}&order=start_time.asc`, { auth:true });
    if (!courses?.length){ alert(`ä»Šå¤©ï¼ˆ${today}ï¼‰æ²’æœ‰èª²ç¨‹`); return; }

    let chosen = courses[0];
    if (courses.length > 1){
      const list = courses.map((c,i)=> `${i+1}. ${c.title} ${c.start_time?c.start_time.slice(0,5):''}~${c.end_time?c.end_time.slice(0,5):''}`).join('\n');
      const ans = prompt(`ä»Šå¤©å…±æœ‰ ${courses.length} é–€èª²ï¼Œè«‹è¼¸å…¥è¦åŒ¯å‡ºçš„ç·¨è™Ÿï¼š\n${list}`);
      const idx = parseInt(ans,10);
      if (!(idx>=1 && idx<=courses.length)){ alert('å·²å–æ¶ˆåŒ¯å‡º'); return; }
      chosen = courses[idx-1];
    }

    const rows = await rest(`/rest/v1/attendance?select=student_id&course_id=eq.${encodeURIComponent(chosen.id)}`, { auth:true });
    const ids = Array.from(new Set((rows||[]).map(r=> r.student_id)));
    if (!ids.length){ alert('æ²’æœ‰å‡ºå¸­ç´€éŒ„'); return; }

    const idList = '(' + ids.join(',') + ')';
    const students = await rest(`/rest/v1/students?select=id,team,name,employee_no&id=in.${encodeURIComponent(idList)}`, { auth:true });

    const seen = new Set(); const out = [];
    (students||[]).forEach(s=>{
      if (seen.has(s.id)) return; seen.add(s.id);
      out.push({ team:s.team||'', name:s.name||'', employee_no:s.employee_no||'' });
    });

    const csvCell = (v)=>{ let s = (v==null? '' : String(v)); return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s; };
    const sanitize = (s)=> String(s||'').replace(/[\\/:*?"<>|]+/g,'_');

    const header = 'Team,Name(EN),ID\n';
    const body = out.map(s=> `${csvCell(s.team)},${csvCell(s.name)},${csvCell(s.employee_no)}`).join('\n');
    const csv = header + body + '\n';

    const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${today}_${sanitize(chosen.title)}_attendance.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  }

  // ===== è£ç½®åµæ¸¬ï¼ˆå³ä¸Šæç¤ºï¼‰=====
  (function(){
    function deviceType(){
      const w = Math.min(window.innerWidth||0, (screen&&screen.width)||0);
      if (w < 600) return 'Phone'; if (w < 1025) return 'Tablet'; return 'Desktop';
    }
    function updateDeviceText(){ const el=$('#deviceText'); if(!el) return; el.textContent=deviceType()+', Today: ' + todayStr(); }
    window.addEventListener('DOMContentLoaded', updateDeviceText);
    window.addEventListener('resize', updateDeviceText);
    if (document.readyState==='interactive' || document.readyState==='complete') updateDeviceText();
  })();

  // ===== æ—¥æœŸ/æ™‚é–“è¼¸å…¥ï¼šè‡ªè¨‚ç™½è‰²åœ–ç¤ºè¦†è“‹ =====
  (function(){
    function wrapWithPicker(id, kind){
      const inp = document.getElementById(id); if (!inp) return;
      if (inp.closest('.picker-wrap')) return;
      const wrap=document.createElement('div'); wrap.className='picker-wrap';
      inp.parentNode.insertBefore(wrap, inp); wrap.appendChild(inp);
      const btn=document.createElement('button'); btn.type='button'; btn.className='picker-btn ' + (kind==='date'?'calendar':'clock');
      btn.setAttribute('aria-label', kind==='date'?'é–‹å•Ÿæ—¥æœŸé¸æ“‡å™¨':'é–‹å•Ÿæ™‚é–“é¸æ“‡å™¨');
      btn.addEventListener('click', ()=>{ if (typeof inp.showPicker==='function'){ try{ inp.showPicker(); }catch{ inp.focus(); } } else { inp.focus(); } });
      wrap.appendChild(btn);
    }
    function init(){ wrapWithPicker('inpDate','date'); wrapWithPicker('inpStart','time'); wrapWithPicker('inpEnd','time'); }
    if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', init); else init();
  })();

  // ===== éå»èª²ç¨‹è£œç™»ï¼ˆç®¡ç†å“¡ï¼‰=====
const selBackfillCourse = $('#selBackfillCourse');
const btnLoadBackfill   = $('#btnLoadBackfill');
const backfillMsg       = $('#backfillMsg');
const backfillTbody     = $('#backfillTbody');
const inpBulkIDs        = $('#inpBulkIDs');
const btnBulkAdd        = $('#btnBulkAdd');
const btnSaveChecked    = $('#btnSaveChecked');

let __bf_students = [];
let __bf_checked  = new Set();
let __bf_toAdd    = new Set();

/* â¬‡â¬‡â¬‡ æŠŠé€™å€‹å‡½å¼æ•´æ®µæ›æ‰ â¬‡â¬‡â¬‡ */
async function loadAllCoursesForBackfill(){
  if (!state.access_token) return;
  selBackfillCourse.innerHTML = '';
  try{
    // åªå–ã€Œä»Šå¤©ä»¥å‰ã€çš„èª²ç¨‹ï¼ˆä¸å«æœªä¾†ï¼‰
    const today = todayStr(); // å·²åœ¨æª”æ¡ˆå‰é¢å®šç¾©é
    const rows = await rest(
      `/rest/v1/courses?select=*&date=lte.${encodeURIComponent(today)}&order=date.desc,start_time.desc&limit=200`,
      { auth:true }
    );

    selBackfillCourse.append(new Option('è«‹é¸æ“‡èª²ç¨‹', ''));
    rows.forEach(c=>{
      const t = c.start_time ? `ï¼ˆ${(c.start_time||'').slice(0,5)}~${(c.end_time||'').slice(0,5)}ï¼‰` : '';
      selBackfillCourse.append(new Option(`${c.date} ${c.title} ${t}`, c.id));
    });

    if (!rows.length){
      backfillMsg.textContent = 'ç›®å‰æ²’æœ‰å¯è£œç™»çš„ï¼ˆä»Šå¤©ä»¥å‰ï¼‰èª²ç¨‹ã€‚';
      backfillMsg.className = 'note warn';
    }else{
      backfillMsg.textContent = '';
      backfillMsg.className = 'note';
    }
  }catch(e){
    backfillMsg.textContent = 'è®€å–èª²ç¨‹æ¸…å–®å¤±æ•—ï¼š' + (e?.message||e);
    backfillMsg.className = 'note error';
  }
}
/* â¬†â¬†â¬† å–ä»£åˆ°é€™è£¡ â¬†â¬†â¬† */

function renderBackfillTable(q = '') {
  backfillTbody.innerHTML = '';

  // é—œéµå­—è™•ç†ï¼šæ”¯æ´ç©ºç™½æˆ–é€—è™Ÿåˆ‡å‰²å¤šé—œéµå­—
  const kw = String(q || '').trim().toLowerCase();
  const terms = kw ? kw.split(/[\s,]+/).filter(Boolean) : [];

  // ç¯©é¸
  let list = __bf_students.slice();
  if (terms.length) {
    list = list.filter(s => {
      const hay = `${s.team || ''} ${s.name || ''} ${s.employee_no || ''}`.toLowerCase();
      return terms.every(t => hay.includes(t));
    });
  }

  // æ²’è³‡æ–™
  if (!list.length) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="4" class="note" style="padding:10px">æ²’æœ‰ç¬¦åˆçš„å­¸å“¡</td>`;
    backfillTbody.appendChild(tr);
    backfillMsg.textContent = 'æ²’æœ‰ç¬¦åˆçš„å­¸å“¡ã€‚';
    backfillMsg.className = 'note';
    return;
  }

  // å»ºåˆ—
  const frag = document.createDocumentFragment();
  list.forEach(s => {
    const already = __bf_checked.has(s.id);   // æ­¤èª²ç¨‹å·²ç¶“å ±åˆ°
    const willAdd = __bf_toAdd.has(s.id);     // é€™æ¬¡æº–å‚™è£œç™»

    const tr = document.createElement('tr');
    tr.style.background = '#0e131b';
    tr.style.border = '1px solid var(--border)';

    // 4 æ¬„ï¼šTeam / Name / ID / ç‹€æ…‹/é¸å–
    const tdTeam = document.createElement('td');
    const tdName = document.createElement('td');
    const tdId   = document.createElement('td');
    const tdAct  = document.createElement('td');

    [tdTeam, tdName, tdId, tdAct].forEach(td => {
      td.style.padding = '8px 10px';
      td.style.borderTop = '1px solid var(--border)';
      td.style.borderBottom = '1px solid var(--border)';
    });

    tdTeam.textContent = s.team || '';
    tdName.textContent = s.name || '';
    tdId.textContent   = s.employee_no || '';
    tdAct.style.textAlign = 'center';

    if (already) {
      // å·²å ±åˆ°è€…ï¼šé¡¯ç¤ºå¾½ç« ï¼Œä¸å¯å‹¾é¸
      const chip = document.createElement('span');
      chip.className = 'chip';
      chip.textContent = 'å·²å ±åˆ°';
      chip.style.background = '#12392c';
      chip.style.border = '1px solid #1f6b51';
      tdAct.appendChild(chip);
    } else {
      // å¯è£œç™»ï¼šæä¾›å‹¾é¸
      const label = document.createElement('label');
      label.style.cursor = 'pointer';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.checked = willAdd;
      cb.addEventListener('change', () => {
        if (cb.checked) __bf_toAdd.add(s.id);
        else __bf_toAdd.delete(s.id);
        // é †ä¾¿æ›´æ–°æç¤º
        backfillMsg.textContent = `å·²é¸æ“‡ ${__bf_toAdd.size} ä½å¾…è£œç™»ï¼ˆæ­¤èª²ç¨‹åŸæœ¬å·²å ±åˆ° ${__bf_checked.size} ä½ï¼‰ã€‚`;
        backfillMsg.className = 'note';
      });
      label.append(cb);
      label.append(document.createTextNode(' å‹¾é¸è£œç™»'));
      tdAct.appendChild(label);
    }

    tr.append(tdTeam, tdName, tdId, tdAct);

    // åœ“è§’ï¼ˆå·¦å³ï¼‰
    tr.firstElementChild.style.borderLeft = '1px solid var(--border)';
    tr.firstElementChild.style.borderTopLeftRadius = '10px';
    tr.firstElementChild.style.borderBottomLeftRadius = '10px';
    tr.lastElementChild.style.borderRight = '1px solid var(--border)';
    tr.lastElementChild.style.borderTopRightRadius = '10px';
    tr.lastElementChild.style.borderBottomRightRadius = '10px';

    frag.appendChild(tr);
  });

  backfillTbody.appendChild(frag);
  backfillMsg.textContent = `å·²é¸æ“‡ ${__bf_toAdd.size} ä½å¾…è£œç™»ï¼ˆæ­¤èª²ç¨‹åŸæœ¬å·²å ±åˆ° ${__bf_checked.size} ä½ï¼‰ã€‚`;
  backfillMsg.className = 'note';
}


  async function buildBackfillList(){
    backfillTbody.innerHTML = '';
    const qid = selBackfillCourse?.value;
    if (!qid){
      backfillMsg.textContent = 'è«‹å…ˆé¸æ“‡èª²ç¨‹';
      backfillMsg.className = 'note warn';
      return;
    }

    backfillMsg.textContent = 'è¼‰å…¥å­¸å“¡ä¸­â€¦';
    backfillMsg.className = 'note';

    try{
      const studs = await rest('/rest/v1/students?select=*&limit=2000', { auth:true });
      __bf_students = studs || [];

      __bf_checked = new Set();
      const att = await rest(`/rest/v1/attendance?select=student_id&course_id=eq.${encodeURIComponent(qid)}`, { auth:true });
      (att || []).forEach(a => __bf_checked.add(a.student_id));

      __bf_toAdd.clear();
      renderBackfillTable(inpBulkIDs?.value || '');
    }catch(e){
      backfillMsg.textContent = 'è¼‰å…¥å¤±æ•—ï¼š' + (e?.message||e);
      backfillMsg.className = 'note error';
    }
  }

  btnLoadBackfill?.addEventListener('click', buildBackfillList);
  btnBulkAdd?.addEventListener('click', () => { renderBackfillTable(inpBulkIDs?.value || ''); });
  inpBulkIDs?.addEventListener('input', () => { renderBackfillTable(inpBulkIDs?.value || ''); });

  btnSaveChecked?.addEventListener('click', async()=>{
    const course_id = selBackfillCourse?.value;
    if (!course_id){
      backfillMsg.textContent='è«‹å…ˆé¸æ“‡èª²ç¨‹';
      backfillMsg.className='note warn';
      return;
    }
    if (!__bf_toAdd.size){
      backfillMsg.textContent='å°šæœªå‹¾é¸ä»»ä½•å­¸å“¡';
      backfillMsg.className='note warn';
      return;
    }

    const rows = Array.from(__bf_toAdd).map(sid=>({ course_id, student_id: sid, user_agent: 'admin-backfill' }));
    try{
      const out = await rest('/rest/v1/attendance?select=student_id', {
        method:'POST', auth:true,
        headers:{ 'Prefer':'return=representation' },
        body: JSON.stringify(rows)
      });
      backfillMsg.textContent = `è£œç™»æˆåŠŸ ${out?.length||0} ç­†ã€‚`;
      backfillMsg.className='note ok';
      __bf_toAdd.clear();
      await buildBackfillList();
      try{ await loadStackedChart(); }catch{}
    }catch(e){
      backfillMsg.textContent = 'è£œç™»å¤±æ•—ï¼š' + (e?.message||e);
      backfillMsg.className='note error';
    }
  });
// ====== å­¸å“¡åå–®ï¼ˆAdminï¼‰======
const stuMsg   = $('#stuMsg');
const stuTable = $('#stuTable');
const stuTbody = $('#stuTbody');
const stuQuery = $('#stuQuery');
const btnStuReload  = $('#btnStuReload');
const btnStuCreate  = $('#btnStuCreate');
const stuPager = $('#stuPager');

const STU_PAGE_SIZE = 20;
let __stu_page = 1;
let __stu_rows = [];   // å¿«å–ç›®å‰æŸ¥è©¢çµæœï¼ˆæœ¬é ï¼‰
let __stu_total = 0;   // ç›®å‰æŸ¥è©¢çµæœç¸½ç­†æ•¸ï¼ˆä¼°ç®—ï¼‰
let __stu_sortKey = 'name'; // å¯ç‚º 'team' | 'name' | 'employee_no'
let __stu_sortDir = 'asc';  // 'asc' | 'desc

function setStuMsg(text, cls='note'){
  if (!stuMsg) return;
  stuMsg.textContent = text || '';
  stuMsg.className = cls || 'note';
}

function buildStuRow(s){
  const tr = document.createElement('tr');
  tr.style.background = '#0e131b';
  tr.style.border = '1px solid var(--border)';

  tr.innerHTML = `
    <td style="padding:8px 10px;border-top:1px solid var(--border);border-bottom:1px solid var(--border)">${escapeHtml(s.team||'')}</td>
    <td style="padding:8px 10px;border-top:1px solid var(--border);border-bottom:1px solid var(--border)">${escapeHtml(s.name||'')}</td>
    <td style="padding:8px 10px;border-top:1px solid var(--border);border-bottom:1px solid var(--border)">${escapeHtml(s.employee_no||'')}</td>
    <td style="padding:8px 10px;text-align:center;border-top:1px solid var(--border);border-bottom:1px solid var(--border)">
      <div class="row" style="justify-content:center">
        <button class="ghost btn-stu-edit">ç·¨è¼¯</button>
        <button class="ghost btn-stu-del">åˆªé™¤</button>
      </div>
    </td>
  `;

  // åœ“è§’ï¼ˆå·¦å³ï¼‰
  tr.firstElementChild.style.borderLeft = '1px solid var(--border)';
  tr.firstElementChild.style.borderTopLeftRadius = '10px';
  tr.firstElementChild.style.borderBottomLeftRadius = '10px';
  tr.lastElementChild.style.borderRight = '1px solid var(--border)';
  tr.lastElementChild.style.borderTopRightRadius = '10px';
  tr.lastElementChild.style.borderBottomRightRadius = '10px';

  // ç¶å®šæ“ä½œ
  tr.querySelector('.btn-stu-edit')?.addEventListener('click', ()=> editStudentAdmin(s));
  tr.querySelector('.btn-stu-del')?.addEventListener('click', ()=> deleteStudentAdmin(s));
  return tr;
}

function renderStuTable(rows){
  stuTbody.innerHTML = '';
  if (!rows?.length){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="4" class="note" style="padding:10px">æ²’æœ‰ç¬¦åˆçš„å­¸å“¡</td>`;
    stuTbody.appendChild(tr);
    return;
  }
  rows.forEach(r => stuTbody.appendChild(buildStuRow(r)));
}

function renderStuPager(total, pageSize, page){
  stuPager.innerHTML = '';
  const totalPages = Math.max(1, Math.ceil(total / pageSize));
  const info = document.createElement('span');
  info.className = 'note';
  info.textContent = `ç¬¬ ${page} / ${totalPages} é ï¼ˆTotal: ${total} ç­†ï¼‰`;
  const prev = document.createElement('button');
  prev.className='icon-btn';
  prev.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
  prev.disabled = page<=1;
  prev.addEventListener('click', ()=>{ __stu_page = Math.max(1, __stu_page-1); loadStudentsAdmin(); });

  const next = document.createElement('button');
  next.className='icon-btn';
  next.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
  next.disabled = page>=totalPages;
  next.addEventListener('click', ()=>{ __stu_page = Math.min(totalPages, __stu_page+1); loadStudentsAdmin(); });

  stuPager.append(prev, info, next);
}

async function loadStudentsAdmin(reset=false){
  if (!state.access_token){
    setStuMsg('è«‹å…ˆåœ¨ã€ç™»å…¥ã€‘åˆ†é å®Œæˆç™»å…¥ã€‚','note warn');
    renderStuTable([]);
    stuPager.innerHTML = '';
    return;
  }
  if (reset) __stu_page = 1;

  const q = (stuQuery?.value || '').trim();
  setStuMsg('è¼‰å…¥ä¸­â€¦','note');

  // çµ„æœå°‹èˆ‡åˆ†é åƒæ•¸
  const like   = (s)=> `*${encodeURIComponent(s)}*`;
  const orExpr = q ? `&or=(team.ilike.${like(q)},name.ilike.${like(q)},employee_no.ilike.${like(q)})` : '';
  const from   = ((__stu_page - 1) * STU_PAGE_SIZE);

  try{
    const { rows, total } = await restWithCount(
      `/rest/v1/students?select=*&order=${encodeURIComponent(__stu_sortKey)}.${encodeURIComponent(__stu_sortDir)}.nullslast${orExpr}`,
      { auth:true, limit: STU_PAGE_SIZE, offset: from }
    );

    __stu_rows  = Array.isArray(rows) ? rows : [];
    __stu_total = typeof total === 'number' ? total : __stu_rows.length;

    renderStuTable(__stu_rows);
    renderStuPager(__stu_total, STU_PAGE_SIZE, __stu_page);
    setStuMsg(`å…± ${__stu_total} åï¼ˆThis Page: ${__stu_rows.length} ç­†ï¼‰`, 'note');
    updateStuSortIcons();
  }catch(e){
    setStuMsg('è¼‰å…¥å¤±æ•—ï¼š' + (e?.message || e), 'note error');
    renderStuTable([]);
    stuPager.innerHTML = '';
  }
}


// === æ–°å¢ï¼šè¡¨é ­æ’åºæ§åˆ¶ ===
function updateStuSortIcons(){
  const ths = stuTable?.querySelectorAll('thead th[data-sort]');
  if (!ths) return;
  ths.forEach(th=>{
    const key = th.getAttribute('data-sort');
    const icon = th.querySelector('.sort-icon');
    if (!icon) return;
    if (key === __stu_sortKey){
      icon.textContent = (__stu_sortDir === 'asc') ? 'â–²' : 'â–¼';
      icon.style.opacity = '1';
    }else{
      icon.textContent = '';
      icon.style.opacity = '.7';
    }
  });
}

function initStuSortHeaders(){
  const ths = stuTable?.querySelectorAll('thead th[data-sort]');
  if (!ths) return;
  ths.forEach(th=>{
    th.addEventListener('click', ()=>{
      const key = th.getAttribute('data-sort');
      if (!key) return;
      if (__stu_sortKey === key){
        __stu_sortDir = (__stu_sortDir === 'asc') ? 'desc' : 'asc';
      }else{
        __stu_sortKey = key;
        __stu_sortDir = 'asc';
      }
      updateStuSortIcons();
      loadStudentsAdmin(true); // é‡æ–°æŸ¥è©¢ä¸¦å›åˆ°ç¬¬ 1 é 
    });
  });

  updateStuSortIcons();
}


btnStuReload?.addEventListener('click', ()=> loadStudentsAdmin(true));
stuQuery?.addEventListener('input', ()=> loadStudentsAdmin(true));
btnStuCreate?.addEventListener('click', createStudentAdmin);

async function createStudentAdmin(){
  if (!state.access_token) { alert('è«‹å…ˆç™»å…¥'); return; }
  const team = prompt('Teamï¼ˆçµ„ç«™ï¼‰ï¼š');
  if (team===null) return;
  const name = prompt('Nameï¼ˆè‹±æ–‡ï¼‰ï¼š');
  if (name===null) return;
  const employee_no = prompt('IDï¼ˆå·¥è™Ÿï¼‰ï¼š');
  if (employee_no===null) return;

  try{
    await rest('/rest/v1/students?select=*', {
      method:'POST', auth:true,
      headers:{ 'Prefer':'return=representation' },
      body: JSON.stringify({ team, name, employee_no })
    });
    setStuMsg('æ–°å¢æˆåŠŸ','note ok');
    await loadStudentsAdmin(true);

    // è‹¥ç•¶å‰åœåœ¨å­¸å“¡å ±åˆ°é ï¼Œå¯åŒæ­¥åˆ·æ–°åå–®ï¼ˆä¸æ“¾æ°‘åœ° tryï¼‰
    try{ await loadStudentsAndAttendance(); }catch{}
  }catch(e){
    // 409 / unique constraint æ™‚çµ¦å‹å–„è¨Šæ¯
    const msg = String(e?.message || '');
    if (e?.status===409 || /duplicate|unique/i.test(msg)){
      alert('æ–°å¢å¤±æ•—ï¼šID é‡è¤‡æˆ–å”¯ä¸€éµè¡çªã€‚');
    }else{
      alert('æ–°å¢å¤±æ•—ï¼š' + msg);
    }
  }
}

async function editStudentAdmin(s){
  if (!state.access_token) { alert('è«‹å…ˆç™»å…¥'); return; }
  const team = prompt('Teamï¼ˆçµ„ç«™ï¼‰ï¼š', s.team || '');
  if (team===null) return;
  const name = prompt('Nameï¼ˆè‹±æ–‡ï¼‰ï¼š', s.name || '');
  if (name===null) return;
  const employee_no = prompt('IDï¼ˆå·¥è™Ÿï¼‰ï¼š', s.employee_no || '');
  if (employee_no===null) return;

  try{
    await rest(`/rest/v1/students?id=eq.${encodeURIComponent(s.id)}`, {
      method:'PATCH', auth:true,
      body: JSON.stringify({ team, name, employee_no })
    });
    setStuMsg('æ›´æ–°æˆåŠŸ','note ok');
    await loadStudentsAdmin();

    // åŒæ­¥åˆ·æ–°å­¸å“¡å ±åˆ°é çš„æœ¬åœ°åå–®ï¼ˆéé˜»å¡ï¼‰
    try{ await loadStudentsAndAttendance(); }catch{}
  }catch(e){
    const msg = String(e?.message || '');
    if (e?.status===409 || /duplicate|unique/i.test(msg)){
      alert('æ›´æ–°å¤±æ•—ï¼šID é‡è¤‡æˆ–å”¯ä¸€éµè¡çªã€‚');
    }else{
      alert('æ›´æ–°å¤±æ•—ï¼š' + msg);
    }
  }
}

async function deleteStudentAdmin(s){
  if (!state.access_token) { alert('è«‹å…ˆç™»å…¥'); return; }

  const label = `${s.name || ''}ï¼ˆ${s.employee_no || ''}ï¼‰`;

  // å…ˆç¢ºèªæ˜¯å¦åˆªé™¤
  if (!confirm(`ç¢ºå®šè¦åˆªé™¤å­¸å“¡ ${label} ï¼Ÿ`)) return;

  // å°å·¥å…·ï¼šæŠ“ä¸€å€‹å­¸å“¡è¢«å¤šå°‘å‡ºå¸­ç´€éŒ„åƒç…§
  async function countAttendanceOfStudent(studentId){
    try{
      const { rows, total } = await restWithCount(
        `/rest/v1/attendance?select=student_id&student_id=eq.${encodeURIComponent(studentId)}`,
        { auth:true, limit:1, offset:0 }
      );
      return typeof total === 'number' ? total : (rows?.length || 0);
    }catch(_){ return 0; }
  }

  // åˆª attendanceï¼ˆå›å‚³å¯¦éš›åˆªé™¤ç­†æ•¸ï¼‰
  async function deleteAttendanceByStudent(studentId){
    const res = await rest(`/rest/v1/attendance?student_id=eq.${encodeURIComponent(studentId)}`, {
      method: 'DELETE', auth: true,
      headers: { 'Prefer': 'return=representation', 'Accept':'application/json' }
    });
    return Array.isArray(res) ? res.length : 0;
  }

  // åˆª studentsï¼ˆè¦æ±‚æŠŠè¢«åˆªçš„é‚£åˆ—å›å‚³ï¼Œç”¨ä¾†ç¢ºèªæ˜¯å¦çœŸçš„åˆªåˆ°ï¼‰
  async function deleteStudentRow(studentId){
    const res = await rest(`/rest/v1/students?id=eq.${encodeURIComponent(studentId)}`, {
      method: 'DELETE', auth: true,
      headers: { 'Prefer': 'return=representation', 'Accept':'application/json' }
    });
    return Array.isArray(res) ? res.length : 0;
  }

  try{
    // 1) å…ˆçœ‹æœ‰æ²’æœ‰è¢« attendance åƒç…§
    const attCount = await countAttendanceOfStudent(s.id);
    if (attCount > 0){
      const ok = confirm(
        `åµæ¸¬åˆ°å­¸å“¡ ${label} ä»è¢« ${attCount} ç­†å‡ºå¸­ç´€éŒ„åƒç…§ã€‚\n\nè¦å…ˆåˆªé™¤é€™äº›å‡ºå¸­ç´€éŒ„å†åˆªå­¸å“¡å—ï¼Ÿ`
      );
      if (!ok) { alert('å·²å–æ¶ˆåˆªé™¤ã€‚'); return; }

      const delAtt = await deleteAttendanceByStudent(s.id);
      if (delAtt < attCount){
        setStuMsg(`åƒ…åˆªé™¤ ${delAtt}/${attCount} ç­†å‡ºå¸­ç´€éŒ„ï¼Œå¯èƒ½å—æ¬Šé™ï¼ˆRLSï¼‰é™åˆ¶ã€‚`, 'note warn');
      }
    }

    // 2) åˆªå­¸å“¡æœ¬èº«
    const delStu = await deleteStudentRow(s.id);
    if (delStu === 1){
      setStuMsg('åˆªé™¤æˆåŠŸ','note ok');
    } else if (delStu === 0){
      setStuMsg('æœªåˆªé™¤ä»»ä½•è³‡æ–™ï¼šå¯èƒ½æ˜¯æ¬Šé™/RLS é™åˆ¶ã€‚è«‹æª¢æŸ¥ Supabase çš„ RLS policy æ˜¯å¦å…è¨±ç›®å‰èº«åˆ†åˆªé™¤ studentsã€‚', 'note danger');
      alert('åˆªé™¤å¤±æ•—ï¼šç›®å‰ç™»å…¥çš„è§’è‰²æ²’æœ‰åˆªé™¤æ¬Šé™ï¼ˆRLSï¼‰ã€‚\nè«‹åœ¨ Supabase èª¿æ•´ students/attendance çš„ RLS policy æˆ–æ”¹ç”¨æ“æœ‰è€…å¸³è™Ÿã€‚');
      return;
    }

  }catch(e){
    const msg = String(e?.message || '');

    if (e?.status === 401 || e?.status === 403 || /jwt|token|expired/i.test(msg)){
      setStuMsg('åˆªé™¤å¤±æ•—ï¼šç™»å…¥å·²éæœŸæˆ–æ¬Šé™ä¸è¶³ï¼Œè«‹åˆ°ã€Œç™»å…¥ã€åˆ†é é‡æ–°ç™»å…¥å¾Œå†è©¦ã€‚', 'note danger');
      alert('åˆªé™¤å¤±æ•—ï¼šç™»å…¥éæœŸæˆ–æ¬Šé™ä¸è¶³ï¼Œè«‹é‡æ–°ç™»å…¥ã€‚');
      return;
    }

    if (e?.status === 409 || e?.code === '23503' || /foreign key|violates foreign key/i.test(msg)){
      alert('åˆªé™¤å¤±æ•—ï¼šä»æœ‰å¤–éµåƒç…§ï¼ˆattendanceï¼‰ã€‚\nè«‹é‡æ•´å¾Œå†è©¦ä¸€æ¬¡ï¼Œæˆ–æª¢æŸ¥ RLS policy æ˜¯å¦å…è¨±åˆª attendanceã€‚');
      return;
    }

    alert('åˆªé™¤å¤±æ•—ï¼š' + msg);
    return;
  }

  // âœ… å‰ç«¯è¡¨æ ¼èˆ‡å ±åˆ°é åŒæ­¥åˆ·æ–°
  if (__stu_rows.length === 1 && __stu_page > 1) __stu_page--;
  await loadStudentsAdmin();
  try { await loadStudentsAndAttendance(); } catch {}
}


    // ===== åˆå§‹è¼‰å…¥ =====
  function initAdminPickers(){ ['inpDate','inpStart','inpEnd'].forEach(id=>{ const el=document.getElementById(id); if(!el) return; }); }
  refreshAuthUI();
  ensureAdminDefaultTab();
  setupBroadcastReceiver();   // â† æ–°å¢ï¼šé–‹å§‹æ¥æ”¶ä»–è£ç½®çš„å ±åˆ°å»£æ’­
  loadToday();
  initAdminPickers();

  // ===== Icon æŒ‰éˆ•é»æ“Šæ—‹è½‰å‹•ç•« =====
  document.querySelectorAll('.icon-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      btn.classList.add('spin');
      // å‹•ç•«çµæŸå¾Œç§»é™¤ classï¼Œé¿å…ä¸‹æ¬¡ç„¡æ•ˆ
      btn.addEventListener('animationend', ()=>{
        btn.classList.remove('spin');
      }, {once:true});
    });
  });
</script>
<script>
(function(){
  var SECRET_CODE = 'QACQE';
  var KEY = 'cqe_gate_ok';
  var TTL_MS = 12 * 60 * 60 * 1000; // 12 å°æ™‚

  function setTicket(persist){
    var ticket = { ok: true, exp: Date.now() + TTL_MS };
    (persist ? localStorage : sessionStorage).setItem(KEY, JSON.stringify(ticket));
  }

  function nextUrl(){
    // è‹¥æœ‰ redir åƒæ•¸ï¼ŒæˆåŠŸå¾Œå›åŸé 
    var u = new URL(location.href);
    var redir = u.searchParams.get('redir');
    if (redir) return redir;

    // å¦å‰‡ä¾è£ç½®å°å‘
    var isMobile = false;
    try {
      isMobile = window.matchMedia && window.matchMedia('(max-width: 820px)').matches;
    } catch(e){}
    return isMobile ? 'Mobile.html' : 'Desktop.html';
  }

  // ç¶å®š UIï¼šå‡è¨­ä½ çš„è¼¸å…¥æ¡† id="gate", é€å‡ºæŒ‰éˆ• id="enterBtn", ä»¥åŠã€Œè¨˜ä½æˆ‘ã€å‹¾é¸ id="remember"
  document.addEventListener('DOMContentLoaded', function(){
    var $input = document.getElementById('gate');
    var $btn = document.getElementById('enterBtn');
    var $remember = document.getElementById('remember'); // å¯é¸ï¼Œæ²’æœ‰ä¹Ÿä¸å½±éŸ¿

    function tryEnter(){
      if (!$input) return;
      var code = ($input.value || '').trim();
      if (code === SECRET_CODE){
        var persist = $remember && $remember.checked; // å‹¾é¸å°±å¯« localStorageï¼Œä¸å‹¾é¸ç”¨ sessionStorage
        setTicket(persist);
        location.href = nextUrl();
      } else {
        // éŒ¯èª¤ä¸æç¤ºå…§å®¹ï¼Œé¿å…æ´©æ¼ï¼›ä½ ä¹Ÿå¯ä»¥åŠ ä¸Šè¼•å¾®æŠ–å‹•æˆ–é‚Šæ¡†è®Šè‰²
        $input.value = '';
        $input.focus();
      }
    }

    if ($btn) $btn.addEventListener('click', tryEnter);
    if ($input) $input.addEventListener('keydown', function(e){
      if (e.key === 'Enter') tryEnter();
    });
  });
})();
</script>

</body>
</html>

