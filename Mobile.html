<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>CQE | AI Class Check-Inï¼ˆMobileï¼‰</title>
<meta name="description" content="Mobile-first, today-only check-in: search or enter employee ID, tap to check in.">

<style>
  :root{
    --bg:#0f1115; --card:#151922; --fg:#e7ebf2; --muted:#9aa5b1;
    --accent:#0070C0; --ok:#44c08a; --warn:#ffb020; --danger:#ff645d;
    --border:#273043; --radius:16px; --gap:12px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.55 system-ui,-apple-system,"Segoe UI","Microsoft JhengHei",sans-serif}
  .wrap{max-width:680px;margin:0 auto;padding:16px}
  header{display:flex;align-items:center;gap:10px;margin:2px 0 10px}
  .logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#2a2f3a,#1b2130);display:grid;place-items:center}
  h1{font-size:18px;margin:0}
  .sub{color:var(--muted);font-size:12px;margin-top:2px}

  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:12px}
  input,select{width:100%;padding:12px 14px;border-radius:14px;border:1px solid var(--border);background:#0e131b;color:#e7ebf2;font-size:16px}
  input::placeholder{color:#7d8896}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .btn{
    appearance:none;border:none;background:var(--accent);color:#fff;border-radius:14px;
    padding:12px 14px;line-height:1.2;cursor:pointer;width:100%;font-weight:600;
    text-shadow:0 1px 2px rgba(0,0,0,.65)
  }
  .btn.ghost{background:#1b2433;border:1px solid var(--border);color:#fff}
  .btn.inline{width:auto;padding:10px 12px}
  .note{font-size:12px;color:var(--muted);margin-top:6px}
  .warn{color:var(--warn)} .ok{color:var(--ok)} .error{color:var(--danger)}

  /* å­¸å“¡åˆ—è¡¨ */
  #list{display:grid;gap:8px;margin-top:8px}
  .item{
    display:flex;align-items:center;gap:12px;
    background:#0e131b;border:1px solid var(--border);border-radius:14px;padding:12px 14px;
    touch-action:manipulation; -webkit-tap-highlight-color: transparent;
  }
  .av{width:36px;height:36px;border-radius:50%;background:#1b2130;display:grid;place-items:center;font-size:13px;font-weight:700;letter-spacing:.5px}
  .name{font-weight:700}
  .tag-ok{margin-left:auto;font-size:11px;background:#12392c;color:#9af0c7;border:1px solid #1f6b51;border-radius:999px;padding:3px 8px}
  .checked{outline:2px solid #2a6f55}

  /* åº•éƒ¨æ“ä½œåˆ—ï¼ˆç©ºé–“ç²¾ç°¡ï¼‰ */
  .dock{
    position:sticky;bottom:0;left:0;right:0;
    padding-top:6px;            /* â¬…ï¸ ä¸Šæ–¹ç©ºé–“ç¸®å° */
    padding-bottom:0;           /* â¬…ï¸ ä¸‹æ–¹ç©ºé–“ç¸®å° */
    background:linear-gradient(180deg, rgba(15,17,21,0), rgba(15,17,21,.9) 28%, rgba(15,17,21,1));
    backdrop-filter: blur(6px);
  }
  /* åªç²¾ç°¡ dock å€å¡Šå…§å¡ç‰‡èˆ‡è¡Œè· */
  .dock .card{ padding:8px 10px; }
  .dock .card h3{ margin:0 0 6px; }
  .dock .row{ gap:6px; }
  .dock .row + .row{ margin-top:4px !important; } /* æ¯”åŸæœ¬ 6px æ›´ç·Šæ¹Š */

  /* åˆ‡æ›éˆ• */
  .switcher{
    position:fixed; left:12px; bottom:12px; z-index:50;
    background:#1b2433; color:#e7ebf2; border:1px solid var(--border);
    border-radius:999px; padding:10px 12px; font-size:13px; text-decoration:none;
  }

  /* Toast */
  .toast{
    position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
    background:#0e131b;border:1px solid var(--border);color:#fff;padding:10px 14px;border-radius:12px;
    box-shadow:0 10px 30px rgba(0,0,0,.35);opacity:0;pointer-events:none;transition:opacity .2s, transform .2s;
  }
  .toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)}
  .toast.success{ background:#12392c; border-color:#1f6b51; }
  .toast.dup    { background:#102238; border-color:#2a4370; }
  .toast.error  { background:#3a1212; border-color:#7a2b2b; }

  /* Modal */
  .modal-mask{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:100}
  .modal{background:#151922;padding:20px;border:1px solid var(--border);border-radius:16px;width:90%;max-width:420px;color:#fff}
  .modal h3{margin:0 0 10px;font-size:16px}
  .modal label{display:block;font-size:12px;color:var(--muted);margin:10px 0 4px}
</style>
</head>
<body>
<div class="wrap">
<header>
  <div class="logo">
    <img src="bear-logo.png" alt="Logo" style="width:100%;height:100%;object-fit:contain;border-radius:12px">
  </div>
  <div>
    <h1>CQE | AI Class Check-In</h1>
    <div class="sub" id="todayTxt">ä»Šå¤©ï¼š</div>
  </div>
</header>

  <!-- Next Classï¼ˆæ¨™é¡Œ + å³å´çµ±è¨ˆ/æç¤ºï¼‰ -->
  <section class="card">
    <div class="row" style="align-items:center;justify-content:space-between">
      <h3 style="margin:0">Next Class</h3>
      <div id="tipCourse" class="note"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <select id="selCourse" aria-label="é¸æ“‡ä»Šæ—¥èª²ç¨‹"></select>
      <button id="btnReload" class="btn inline ghost" type="button">é‡æ–°è¼‰å…¥</button>
    </div>
  </section>

  <!-- å¿«é€Ÿæœå°‹ / é»å -->
  <section class="card" style="margin-top:10px">
    <h3>å¿«é€Ÿæœå°‹ / é»å</h3>
    <input id="q" placeholder="æœå°‹å­¸å“¡ï¼ˆTeam / Name / IDï¼‰" autocomplete="off" inputmode="search">
    <div id="list"></div>
    <div id="emptyMsg" class="note"></div>
  </section>

  <!-- è‡ªåŠ©å ±åˆ°ï¼ˆå·²ç²¾ç°¡ä¸Šä¸‹ç©ºé–“ï¼‰ -->
  <div class="dock">
    <section class="card">
      <h3>è‡ªåŠ©å ±åˆ°</h3>
      <div class="row">
        <input id="emp" placeholder="ä¾‹å¦‚ï¼šA123456" autocomplete="off" inputmode="text" />
        <button id="btnIn" class="btn" type="button">ç«‹å³å ±åˆ°</button>
      </div>
      <div class="row" style="margin-top:6px">
        <button id="btnClear" class="btn ghost" type="button">æ¸…é™¤</button>
      </div>
      <div id="msg" class="note"></div>
    </section>
  </div>
</div>

<a class="switcher" href="Desktop.html?view=desktop" title="åˆ‡æ›åˆ°æ¡Œæ©Ÿç‰ˆ">â†”ï¸ æ¡Œæ©Ÿç‰ˆ</a>
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- è‡ªåŠ©å»ºç«‹å­¸å“¡ Modal -->
<div id="modalNewMask" class="modal-mask" role="dialog" aria-modal="true" aria-labelledby="modalNewTitle">
  <div class="modal">
    <h3 id="modalNewTitle">ä¸åœ¨åå–®ï¼Ÿè‡ªåŠ©å»ºç«‹å­¸å“¡</h3>
    <label>å·¥è™Ÿ</label>
    <input id="newEmp" type="text" placeholder="ä¾‹å¦‚ï¼šA123456" autocomplete="off">
    <label>Teamï¼ˆå¿…å¡«ï¼‰</label>
    <input id="newTeam" type="text" placeholder="Team(çµ„ç«™)" autocomplete="off">
    <label>å§“å</label>
    <input id="newName" type="text" placeholder="è‹±æ–‡" autocomplete="off">
    <div class="row" style="margin-top:12px;justify-content:flex-end">
      <button id="btnCancelNew" class="btn ghost inline" type="button">å–æ¶ˆ</button>
      <button id="btnSaveNew" class="btn inline" type="button">å»ºç«‹</button>
    </div>
  </div>
</div>

<script>
/* ===== Supabase ===== */
const SUPABASE_URL = 'https://kxyguqnoudtnxkexbsnc.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4eWd1cW5vdWR0bnhrZXhic25jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5MzQxODUsImV4cCI6MjA3MTUxMDE4NX0.Tpv6J1KM10lyrLORWdXjN45YGedcCrjdjjdYV61qp38';

const $ = (q)=>document.querySelector(q);
const selCourse = $('#selCourse'), btnReload=$('#btnReload');
const q = $('#q'), list = $('#list'), emptyMsg=$('#emptyMsg');
const emp = $('#emp'), btnIn=$('#btnIn'), btnClear=$('#btnClear'), msg=$('#msg');
const modalMask = $('#modalNewMask'), newEmp=$('#newEmp'), newName=$('#newName'), newTeam=$('#newTeam');
const btnCancelNew=$('#btnCancelNew'), btnSaveNew=$('#btnSaveNew');

const fmt=(d)=> d<10?('0'+d):(''+d);
const todayStr = ()=>{ const d=new Date(); return `${d.getFullYear()}-${fmt(d.getMonth()+1)}-${fmt(d.getDate())}`; };
$('#todayTxt').textContent = 'ä»Šå¤©ï¼š' + todayStr();

/* Toastï¼ˆæ”¯æ´ success / dup / errorï¼‰ */
function toast(text, type='success'){
  const el = $('#toast');
  el.textContent = text;
  el.classList.remove('success','dup','error');
  if (type==='success' || type==='dup' || type==='error'){ el.classList.add(type); }
  el.classList.add('show');
  clearTimeout(el.__t);
  el.__t = setTimeout(()=> el.classList.remove('show'), 1800);
}

/* RESTï¼ˆèˆ‡æ¡Œæ©Ÿç‰ˆä¸€è‡´ï¼Œå¸¶ Authorization: Bearer anon-keyï¼‰ */
async function rest(path,{method='GET',body=null,headers={}}={}){
  const h = {
    'apikey': SUPABASE_ANON_KEY,
    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
    'Accept':'application/json',
    ...headers
  };
  if (body && !h['Content-Type']) h['Content-Type']='application/json';
  const res = await fetch(SUPABASE_URL+path,{method,headers:h,body});
  const txt = await res.text();
  let data=null; try{ data = txt? JSON.parse(txt): null }catch{ data = txt }
  if (!res.ok) throw new Error(data?.message || data?.error || (res.status+' '+res.statusText));
  return data;
}

/* Avatarï¼šå§“åç¸®å¯«ï¼ˆæ¯å­—ç¬¬ä¸€ç¢¼ï¼Œæœ€å¤šå…©ç¢¼ï¼‰ */
function getInitials(name){
  if (!name) return '?';
  const parts = name.trim().split(/\s+/);
  if (parts.length === 1){ return parts[0].slice(0,2).toUpperCase(); } // ä¸­æ–‡æˆ–å–®å­—è‹±æ–‡
  return parts.map(p => p[0]).slice(0,2).join('').toUpperCase();       // å¤šå­—è‹±æ–‡
}

/* HTML è½‰ç¾© */
function escapeHtml(str){
  return String(str||'').replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s]));
}

/* ===== ç‹€æ…‹èˆ‡å·¥å…· ===== */
let STUDENTS = [];
let CHECKED = new Set();
let currentCourseId = null;

// æ˜¯å¦ç‚ºã€Œä»Šæ—¥èª²ç¨‹ã€ï¼ˆå½±éŸ¿æ˜¯å¦å…è¨±å ±åˆ°ï¼‰
let isTodayCourse = true;
// ä»¥ id å¿«å–èª²ç¨‹ç‰©ä»¶ï¼ˆç”¨æ–¼åˆ‡æ›æ™‚åˆ¤æ–·æ—¥æœŸï¼‰
let COURSE_BY_ID = new Map();

/* âœ… çµ±è¨ˆå‡½å¼ï¼ˆå·²å ±åˆ° / æœªå ±åˆ° / åƒèˆ‡ç‡ï¼‰ */
function updateStats(){
  const total = STUDENTS.length;
  const checked = CHECKED.size;
  const unchecked = Math.max(0, total - checked);
  const rate = total > 0 ? Math.round(checked * 100 / total) : 0;
  const tip = document.getElementById('tipCourse');
  if (!tip) return;

  if (isTodayCourse){
    tip.classList.remove('warn','error');
    tip.textContent = `å·²å ±åˆ°: ${checked} äºº, æœªå ±åˆ°: ${unchecked} äºº, åƒèˆ‡ç‡: ${rate}%`;
  }else{
    tip.classList.remove('error');
    tip.classList.add('warn');
    tip.textContent = '*éç•¶æ—¥èª²ç¨‹,ç„¡æ³•å ±åˆ°';
  }
}

/* ä¾ isTodayCourse é–å®šè¼¸å…¥èˆ‡æŒ‰éˆ• */
function applyCheckinLock(){
  btnIn.disabled = !isTodayCourse;
  emp.disabled   = !isTodayCourse;
  updateStats();
}

/* ä»Šæ—¥èª²ç¨‹ï¼ˆè‹¥ç„¡ â†’ fallback ä¸‹ä¸€å ´èª²ç¨‹å”¯è®€ï¼‰ */
async function loadTodayCourses(){
  selCourse.innerHTML = '';
  COURSE_BY_ID.clear();
  isTodayCourse = true;

  try{
    const today = todayStr();

    // 1) å…ˆæŠ“ã€Œä»Šæ—¥ã€çš„èª²ç¨‹
    let rows = await rest('/rest/v1/courses?select=*&date=eq.'+today);
    if (rows?.length){
      selCourse.append(new Option('è«‹é¸æ“‡èª²ç¨‹',''));
      rows.sort((a,b)=> (a.start_time||'').localeCompare(b.start_time||''));
      rows.forEach(c=>{
        COURSE_BY_ID.set(c.id, c);
        const t = c.start_time? `ï¼ˆ${c.start_time.slice(0,5)}~${(c.end_time||'').slice(0,5)}ï¼‰` : '';
        selCourse.append(new Option(`${c.title} ${t}`, c.id));
      });
      isTodayCourse = true;
      applyCheckinLock();
      if (rows.length===1){ selCourse.value = rows[0].id; await loadStudents(); }
      return;
    }

    // 2) æ²’æœ‰ä»Šæ—¥èª² â†’ æŠ“ã€Œä¸‹ä¸€å ´ã€æœªä¾†èª²ç¨‹
    const next = await rest(`/rest/v1/courses?select=*&date=gt.${today}&order=date.asc,start_time.asc&limit=1`);
    if (next?.length){
      const c = next[0];
      COURSE_BY_ID.set(c.id, c);
      const t = c.start_time? `ï¼ˆ${c.start_time.slice(0,5)}~${(c.end_time||'').slice(0,5)}ï¼‰` : '';
      selCourse.append(new Option(`${c.date} ${c.title} ${t}`, c.id));
      selCourse.value = c.id;

      isTodayCourse = false;      // éä»Šæ—¥ â†’ å”¯è®€
      applyCheckinLock();
      await loadStudents();       // é¡¯ç¤ºåå–®ä½†ç¦æ­¢å ±åˆ°
      return;
    }

    // 3) å®Œå…¨æ²’æœ‰æœªä¾†èª²ç¨‹
    selCourse.append(new Option('è¿‘æœŸæ²’æœ‰èª²ç¨‹',''));
    isTodayCourse = false;
    applyCheckinLock();
    const tip = $('#tipCourse'); if (tip){ tip.textContent = 'ç›®å‰æ²’æœ‰å¯é¡¯ç¤ºçš„èª²ç¨‹ã€‚'; tip.classList.add('warn'); }

  }catch(e){
    const tip = $('#tipCourse'); if (tip){ tip.textContent = 'è®€å–èª²ç¨‹å¤±æ•—ï¼š'+e.message; tip.classList.add('error'); }
  }
}

btnReload.addEventListener('click', loadTodayCourses);

/* åˆ‡æ›èª²ç¨‹æ™‚ï¼šåˆ¤æ–·æ˜¯å¦ç‚ºä»Šæ—¥èª²ï¼Œé–å®š/è§£é–å ±åˆ° */
selCourse.addEventListener('change', async ()=>{
  const cid = selCourse.value;
  if (!cid){
    isTodayCourse = true;
    applyCheckinLock();
    list.innerHTML = '';
    emptyMsg.textContent = 'è«‹å…ˆé¸æ“‡èª²ç¨‹';
    return;
  }
  const c = COURSE_BY_ID.get(cid);
  isTodayCourse = !!(c && c.date === todayStr());
  applyCheckinLock();
  await loadStudents();
});

/* åå–®æ¸²æŸ“ */
function renderList(){
  list.innerHTML = '';
  const keyword = (q.value||'').trim().toLowerCase();
  let rows = STUDENTS;

  if (keyword){
    rows = rows.filter(s =>
      (s.team||'').toLowerCase().includes(keyword) ||
      (s.name||'').toLowerCase().includes(keyword) ||
      (s.employee_no||'').toLowerCase().includes(keyword)
    );
  }

  if (!rows.length){
    emptyMsg.textContent = keyword ? 'æ‰¾ä¸åˆ°ç¬¦åˆçš„å­¸å“¡' : 'å°šæœªåŒ¯å…¥å­¸å“¡åå–®';
    updateStats(); // å³ä½¿ç©ºä¹Ÿåˆ·æ–°çµ±è¨ˆ
    return;
  }
  emptyMsg.textContent = '';

  rows.forEach(s=>{
    const el = document.createElement('div');
    const ok = CHECKED.has(s.id);
    el.className = 'item'+(ok?' checked':'');
    el.innerHTML = `
      <div class="av">${escapeHtml(getInitials(s.name||''))}</div>
      <div class="name">${escapeHtml(s.name||'')}</div>
      ${ok?'<span class="tag-ok">å·²å ±åˆ°</span>':''}
    `;
    el.dataset.emp = s.employee_no || '';

    el.addEventListener('click', async()=>{
      if (!currentCourseId){ toast('è«‹å…ˆé¸æ“‡ä»Šæ—¥èª²ç¨‹', 'error'); return; }
      if (!isTodayCourse){ toast('æ­¤ç‚ºã€Œéä»Šæ—¥èª²ç¨‹ã€ï¼Œåƒ…ä¾›æŸ¥çœ‹åå–®ï¼Œç„¡æ³•å ±åˆ°ã€‚', 'error'); return; }
      try{
        await doCheckin(currentCourseId, s.id);
        CHECKED.add(s.id);
        el.classList.add('checked');
        if (!el.querySelector('.tag-ok')){
          const tag=document.createElement('span');
          tag.className='tag-ok'; tag.textContent='å·²å ±åˆ°';
          el.appendChild(tag);
        }
        toast('ğŸ‰ å ±åˆ°æˆåŠŸï¼š'+(s.name||''), 'success');
        updateStats(); // æˆåŠŸå¾Œæ›´æ–°çµ±è¨ˆ
      }catch(e){
        const m = String(e.message||'');
        if (/duplicate key value|conflict|already exists|duplicate/i.test(m)){
          CHECKED.add(s.id);
          el.classList.add('checked');
          if (!el.querySelector('.tag-ok')){
            const tag=document.createElement('span');
            tag.className='tag-ok'; tag.textContent='å·²å ±åˆ°';
            el.appendChild(tag);
          }
          toast('âœ… å·²å ±åˆ°ï¼ˆé‡è¤‡ç•¥éï¼‰', 'dup');
          updateStats(); // é‡è¤‡ä¹Ÿæ›´æ–°çµ±è¨ˆ
        }else{
          toast('âŒ å ±åˆ°å¤±æ•—ï¼š'+m, 'error');
        }
      }
    }, {passive:true});

    list.appendChild(el);
  });

  updateStats(); // åˆæ¬¡æ¸²æŸ“å¾Œæ›´æ–°ä¸€æ¬¡
}

/* è¼‰å…¥å­¸å“¡ + ç•¶å‰èª²ç¨‹å‡ºå¸­æƒ…æ³ */
async function loadStudents(){
  list.innerHTML = ''; q.value='';
  const cid = selCourse.value; currentCourseId = cid || null;
  if (!cid) return;

  try{
    const studs = await rest('/rest/v1/students?select=*&limit=2000');
    STUDENTS = Array.isArray(studs)? studs : [];
    STUDENTS.sort((a,b)=> (a.name||'').localeCompare(b.name||'', 'en', {sensitivity:'base'})); // Aâ†’Z
  }catch(e){
    emptyMsg.textContent = 'è®€å–å­¸å“¡å¤±æ•—ï¼š'+e.message;
    emptyMsg.classList.add('error'); return;
  }

  CHECKED = new Set();
  try{
    const att = await rest(`/rest/v1/attendance?select=student_id&course_id=eq.${encodeURIComponent(cid)}`);
    (att||[]).forEach(a=> CHECKED.add(a.student_id));
  }catch(e){/* ignore */ }

  renderList();
}

/* æœå°‹é˜²æŠ– */
let debounceT=null;
q.addEventListener('input', ()=>{
  clearTimeout(debounceT);
  debounceT = setTimeout(renderList, 120);
});

/* è‡ªåŠ©å ±åˆ°ï¼ˆè¼¸å…¥å·¥è™Ÿï¼‰ */
btnClear.addEventListener('click', ()=>{
  emp.value=''; msg.textContent='';
  emp.focus();
});
emp.addEventListener('keydown', (e)=>{
  if (e.key==='Enter') btnIn.click();
});

btnIn.addEventListener('click', async()=>{
  const cid = selCourse.value;
  const v = (emp.value||'').trim();
  if (!cid){ msg.textContent='è«‹å…ˆé¸æ“‡ä»Šæ—¥èª²ç¨‹ã€‚'; msg.className='note warn'; return; }
  if (!isTodayCourse){
    /* â¬…ï¸ ä¾ä½ çš„éœ€æ±‚ï¼šéä»Šæ—¥èª²ç¨‹æ™‚ï¼Œé»è‡ªåŠ©å ±åˆ°è¦åœ¨ä¸‹æ–¹é¡¯ç¤ºé€™å¥ */
    msg.textContent='åƒ…ç•¶æ—¥èª²ç¨‹æ‰èƒ½é€²è¡Œå ±åˆ°ã€‚';
    msg.className='note warn';
    return;
  }
  if (!v){ msg.textContent='è«‹è¼¸å…¥å·¥è™Ÿã€‚'; msg.className='note warn'; emp.focus(); return; }

  try{
    const stu = await rest('/rest/v1/students?select=*&employee_no=eq.'+encodeURIComponent(v));
    if (!stu?.length){
      // é–‹å•Ÿè‡ªåŠ©å»ºç«‹ Modalï¼ˆé å¡«å·¥è™Ÿï¼‰
      openNewStudentModal(v);
      return;
    }
    const s = stu[0];
    await doCheckin(cid, s.id);
    CHECKED.add(s.id);
    msg.textContent='å ±åˆ°æˆåŠŸï¼'; msg.className='note ok';
    toast('ğŸ‰ å ±åˆ°æˆåŠŸ', 'success');
    emp.value='';
    // åŒæ­¥åˆ—è¡¨ UIï¼šç”¨ data-emp å°æ‡‰ employee_no
    const card = Array.from(list.children).find(x=> (x.dataset.emp||'') === (s.employee_no||''));
    if (card){
      card.classList.add('checked');
      if (!card.querySelector('.tag-ok')){
        const tag=document.createElement('span'); 
        tag.className='tag-ok'; 
        tag.textContent='å·²å ±åˆ°'; 
        card.appendChild(tag);
      }
    }
    updateStats(); // æˆåŠŸå ±åˆ° â†’ åˆ·æ–°çµ±è¨ˆ
  }catch(e){
    const msgText = String(e.message||'');
    if (/duplicate key value|conflict|already exists|duplicate/i.test(msgText)){
      msg.textContent='ä½ ä»Šå¤©å·²ç¶“å ±åˆ°éå›‰ï¼'; msg.className='note ok';
      toast('âœ… å·²å ±åˆ°ï¼ˆé‡è¤‡ç•¥éï¼‰', 'dup');
      updateStats(); // é‡è¤‡å ±åˆ° â†’ ä¹Ÿåˆ·æ–°
    }else{
      msg.textContent='å ±åˆ°å¤±æ•—ï¼š'+msgText; msg.className='note error';
      toast('âŒ å ±åˆ°å¤±æ•—', 'error');
    }
  }
});

/* ====== è‡ªåŠ©å»ºç«‹å­¸å“¡ Modal è¡Œç‚º ====== */
function openNewStudentModal(empNo=''){
  newEmp.value = empNo;
  newName.value = '';
  newTeam.value = '';
  modalMask.style.display = 'flex';
  setTimeout(()=> newName.focus(), 0);
}
function closeNewStudentModal(){
  modalMask.style.display = 'none';
}

// é—œé–‰è¡Œç‚ºï¼šå–æ¶ˆã€é»é®ç½©ã€ESC
btnCancelNew.addEventListener('click', closeNewStudentModal);
modalMask.addEventListener('click', (e)=>{ if (e.target === modalMask) closeNewStudentModal(); });
document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && modalMask.style.display === 'flex') closeNewStudentModal(); });

// å»ºç«‹å­¸å“¡ï¼ˆTeam å¿…å¡«ï¼‰ä¸¦è‡ªå‹•å ±åˆ°ï¼ˆåƒ…ä»Šæ—¥èª²ç¨‹ï¼‰
btnSaveNew.addEventListener('click', onSaveNewStudent);
[newEmp,newName,newTeam].forEach(el=>{
  el.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter'){
      e.preventDefault();
      onSaveNewStudent();
    }
  }, {passive:false});
});

async function onSaveNewStudent(){
  const empNo = (newEmp.value||'').trim();
  const name  = (newName.value||'').trim();
  const team  = (newTeam.value||'').trim();
  if (!empNo || !name || !team){ toast('Team / å§“å / å·¥è™Ÿçš†ç‚ºå¿…å¡«','error'); return; }

  try{
    // å»ºç«‹å­¸å“¡ï¼ˆTeam å¿…å¡«ï¼Œä¸å†å‚³ nullï¼‰
    const ins = await rest('/rest/v1/students?select=*', {
      method:'POST',
      headers:{ 'Prefer':'return=representation' },
      body: JSON.stringify({ employee_no: empNo, name, team })
    });
    const s = Array.isArray(ins) ? ins[0] : ins;

    // è‹¥ç‚ºä»Šæ—¥èª²ç¨‹å‰‡ç›´æ¥å ±åˆ°ï¼›å¦å‰‡åªå»ºç«‹ä¸å ±åˆ°
    if (!currentCourseId || !isTodayCourse){
      toast('å·²å»ºç«‹å­¸å“¡ï¼Œä½†ç›®å‰éä»Šæ—¥èª²ç¨‹ï¼ŒæœªåŸ·è¡Œå ±åˆ°ã€‚','dup');
      closeNewStudentModal();
      // æ›´æ–°å¿«å–åå–®
      STUDENTS.push(s);
      STUDENTS.sort((a,b)=> (a.name||'').localeCompare(b.name||'', 'en', {sensitivity:'base'}));
      renderList();
      return;
    }

    await doCheckin(currentCourseId, s.id);
    CHECKED.add(s.id);
    toast('ğŸ‰ å»ºç«‹ä¸¦å ±åˆ°æˆåŠŸ','success');
    closeNewStudentModal();

    // æ›´æ–°å¿«å–èˆ‡ç•«é¢
    emp.value = '';
    STUDENTS.push(s);
    STUDENTS.sort((a,b)=> (a.name||'').localeCompare(b.name||'', 'en', {sensitivity:'base'}));
    renderList();
  }catch(e){
    toast('âŒ å»ºç«‹å¤±æ•—ï¼š'+(e?.message||e),'error');
  }
}

/* èˆ‡æ¡Œæ©Ÿç‰ˆä¸€è‡´çš„ doCheckinï¼ˆcourse_id + student_idï¼‰ */
async function doCheckin(course_id, student_id){
  try{
    await rest('/rest/v1/attendance', {
      method:'POST',
      headers:{ 'Prefer':'resolution=ignore-duplicates,return=representation' },
      body: JSON.stringify({
        course_id,
        student_id,
        user_agent: navigator.userAgent
      })
    });
    return 'ok';
  }catch(e){
    const m = String(e.message||'');
    if (/duplicate key value|conflict|already exists|duplicate/i.test(m)) return 'dup';
    throw e;
  }
}

/* åˆå§‹åŒ– */
loadTodayCourses();
</script>
</body>
</html>
